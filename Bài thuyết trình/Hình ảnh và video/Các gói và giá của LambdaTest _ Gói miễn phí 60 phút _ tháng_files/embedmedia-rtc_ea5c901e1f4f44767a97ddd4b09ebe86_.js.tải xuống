!function(){"use strict";function E(e){try{return JSON.parse(e)}catch(e){}return"object"==typeof e?e:{}}function R(e){try{return JSON.stringify(e)}catch(e){}return""}function s(e){return"function"==typeof e}function t(l,p,e){var n,t=Object.assign({},{aspectRatio:1.6,widthRange:{min:370,max:(p?window.parent:window).innerWidth},heightRange:{min:200,max:(p?window.parent:window).innerHeight}},e),u=1!==t.aspectRatio,i={},h={},a={},o=0,r=0,s=!1,m={},c="",d=E(localStorage.getItem("siqmedia_ss_playersize")),e=d?d.width:"",d=d?d.height:"";e&&(l.style.width=e+"px"),d&&(l.style.height=d+"px");function g(e,t,i){return Math.min(Math.max(e,t),i)}function y(e){e=e?1:-1;return{width:g(h.width+e*i.x,t.widthRange.min,t.widthRange.max),height:g(h.height+e*i.y,t.heightRange.min,t.heightRange.max),aspectRatioWidth:g(h.width+i.y*(e*t.aspectRatio),t.widthRange.min,t.widthRange.max),aspectRatioHeigth:g(h.height+i.x/(e*t.aspectRatio),t.heightRange.min,t.heightRange.max)}}function _(e,t,i,n){var a,o,r,s,c,d;n+t<=(p?window.parent:window).innerHeight&&i+e<=(p?window.parent:window).innerWidth&&(r=d=o=a="",n===m.top?a=m.top:o=m.bottom,i===m.left?d=m.left:r=m.right,n=e.toString(),i=t.toString(),e=a.toString(),t=o.toString(),a=d.toString(),o=r.toString(),d={width:n,height:i},localStorage.setItem("siqmedia_ss_playersize",R(d)),n&&(l.style.width=n+"px"),i&&(l.style.height=i+"px"),e&&o?(r=i-h.height,d=n-h.width,l.style.top=e+"px",l.style.right=o+"px",l.style.left=u?m.left-d+"px":m.left+"px",l.style.bottom=u?m.bottom-r+"px":m.bottom+"px"):e&&a?(s=i-h.height,c=n-h.width,l.style.top=e+"px",l.style.left=a+"px",l.style.bottom=u?m.bottom-s+"px":m.bottom+"px",l.style.right=u?m.right-c+"px":m.right+"px"):a&&t?(s=i-h.height,c=n-h.width,l.style.left=a+"px",l.style.bottom=t+"px",l.style.top=u?m.top-s+"px":m.top+"px",l.style.right=u?m.right-c+"px":m.right+"px"):t&&o&&(i=i-h.height,n=n-h.width,l.style.bottom=t+"px",l.style.right=o+"px",l.style.top=u?m.top-i+"px":m.top+"px",l.style.left=u?m.left-n+"px":m.left+"px"))}var f={top_left_corner:function(){var e=y(!1);_(e.aspectRatioWidth,e.height,m.right,m.bottom)},top_border:function(){var e=y(!1);_(u?e.aspectRatioWidth:h.width,e.height,m.right,m.bottom)},top_right_corner:function(){var e=y(!0);_(e.width,e.aspectRatioHeigth,m.left,m.bottom)},right_border:function(){var e=y(!0);_(e.width,u?e.aspectRatioHeigth:h.height,m.left,m.bottom)},bottom_right_corner:function(){var e=y(!0);_(e.aspectRatioWidth,e.height,m.left,m.top)},bottom_border:function(){var e=y(!0);_(u?e.aspectRatioWidth:h.width,e.height,m.left,m.top)},bottom_left_corner:function(){var e=y(!1);_(e.width,e.aspectRatioHeigth,m.right,m.top)},left_border:function(){var e=y(!1);_(e.width,u?e.aspectRatioHeigth:h.height,m.right,m.top)}},v=function(e){e.preventDefault(),i={x:e.pageX-a.x,y:e.pageY-a.y},f[c](e)},C=function(e){(p?window.parent:window).removeEventListener("mousemove",v)},I=function(e){!0===s&&(s=!1,(p?window.parent:window).removeEventListener("mousemove",S))},S=function(e){A(e),e.preventDefault();var t=parseInt(getComputedStyle(l,null).getPropertyValue("left").replace("px","")),i=parseInt(getComputedStyle(l,null).getPropertyValue("top").replace("px",""));if(t<0||i<0)return t<0&&(l.style.left="0px"),i<0&&(l.style.top="0px"),s=!1,void(p?window.parent:window).removeEventListener("mousemove",S);var n=parseInt(getComputedStyle(l,null).getPropertyValue("right").replace("px","")),a=parseInt(getComputedStyle(l,null).getPropertyValue("bottom").replace("px",""));if(n<0||a<0){e.pageX,e.pageY;return n<0&&(l.style.left=t+n+"px"),a<0&&(l.style.top=i+a+"px"),n<0&&(l.style.right="0px"),a<0&&(l.style.bottom="0px"),s=!1,void(p?window.parent:window).removeEventListener("mousemove",S)}l.style.left=e.pageX-o+"px",l.style.top=e.pageY-r+"px",l.style.right=(p?window.parent:window).innerWidth-h.width-(e.pageX-o)+"px",l.style.bottom=(p?window.parent:window).innerHeight-h.height-(e.pageY-r)+"px"};function A(e){e.stopPropagation(),e.preventDefault(),e.cancelBubble=!0,e.returnValue=!1}l.addEventListener("mousedown",function(e){var t,i;A(e),e.preventDefault(),h={width:parseInt(getComputedStyle(l,null).getPropertyValue("width").replace("px","")),height:parseInt(getComputedStyle(l,null).getPropertyValue("height").replace("px",""))},a={x:e.pageX,y:e.pageY},n=l.getBoundingClientRect(),m={right:(p?window.parent:window).innerWidth-n.left-h.width,bottom:(p?window.parent:window).innerHeight-n.top-h.height,left:n.left,top:n.top},(c=e.target.getAttribute("position"))?((p?window.parent:window).addEventListener("mousemove",v),(p?window.parent:window).addEventListener("mouseup",C)):(e.preventDefault(),s=!0,t=parseInt(getComputedStyle(l,null).getPropertyValue("left").replace("px","")),i=parseInt(getComputedStyle(l,null).getPropertyValue("top").replace("px","")),o=e.pageX-t,r=e.pageY-i,(p?window.parent:window).addEventListener("mousemove",S),(p?window.parent:window).addEventListener("mouseup",I))})}function f(e,t){this.container=t,this.sdpConstraints={offerToReceiveAudio:!0,offerToReceiveVideo:!1},this.audio="audio",this.screen_share="screen_share",this.video="video",this.curr_connection={audio:!1,screen_share:!1,video:!1},this.init(e)}var v={WAITING_TIME:6e4,RINGTONE_DURATION:65e3,WAITING_TIME_SECS:60,audio:"audio",video:"video",screen_share:"screen_share",screen_view:"screen_view",request_screen:"request_screen",isAlreadySharing:"isAlreadySharing",0:"audio",2:"video",1:"screen_share",connecting:"connecting",connected:"connected",cancelled:"cancelled",sharing:"sharing",viewing:"viewing",facebookUrl:"https://facebook.com/pages",negotiation:"negotiation",height:"200",width:"370",reinit:"reinit",missed:"missed",rejected:"rejected",reconnecting:"reconnecting",requested:"requested",invited:"invited",ended:"ended",end:"end",cancel:"cancel",visitor:"visitor",stopscreen:"stopscreen",click:"click",keyup:"keyup",stopsharing:"stopsharing",activity:{MEDIA_AUDIO_INITIATE:101,MEDIA_AUDIO_ACCEPT:102,MEDIA_AUDIO_OFFER:103,MEDIA_AUDIO_ANSWER:104,MEDIA_AUDIO_CONNECT:105,MEDIA_AUDIO_REJECT:106,MEDIA_AUDIO_CANCEL:107,MEDIA_AUDIO_END:108,MEDIA_AUDIO_MISS:109,MEDIA_AUDIO_UI_SHOWN:131,MEDIA_AUDIO_UI_CLEARED:132,MEDIA_AUDIO_INVITATION_SHOWN:133,MEDIA_AUDIO_INVITATION_CLEARED:134,MEDIA_AUDIO_OUTGOING_UI_SHOWN:135,MEDIA_AUDIO_OUTGOING_UI_CLEARED:136,MEDIA_AUDIO_INCOMING_SOUND_START:146,MEDIA_AUDIO_OUTGOING_SOUND_START:147,MEDIA_AUDIO_SOUND_STOP:148,MEDIA_AUDIO_MIC_PERMISSION_ALLOWED:149,MEDIA_AUDIO_MIC_PERMISSION_BLOCKED:150,MEDIA_AUDIO_MUTE:161,MEDIA_AUDIO_UNMUTE:162,MEDIA_AUDIO_VOICE:163,MEDIA_AUDIO_START:164,MEDIA_AUDIO_RECONNECT_STATE:165,MEDIA_AUDIO_RENEGOTIATION_INITIATE:171,MEDIA_AUDIO_RENEGOTIATION_ACCEPT:172,MEDIA_AUDIO_RENEGOTIATION_CANCEL:173,MEDIA_AUDIO_RENEGOTIATION_REJECT:174,MEDIA_AUDIO_RENEGOTIATION_MISS:175,MEDIA_AUDIO_RENEGOTIATION_TRACKADDED:176,MEDIA_AUDIO_RENEGOTIATION_TRACKREMOVED:177,MEDIA_SCREENSHARE_INITIATE:201,MEDIA_SCREENSHARE_ACCEPT:202,MEDIA_SCREENSHARE_OFFER:203,MEDIA_SCREENSHARE_ANSWER:204,MEDIA_SCREENSHARE_CONNECT:205,MEDIA_SCREENSHARE_REJECT:206,MEDIA_SCREENSHARE_CANCEL:207,MEDIA_SCREENSHARE_END:208,MEDIA_SCREENSHARE_MISS:209,MEDIA_SCREENSHARE_UI_SHOWN:231,MEDIA_SCREENSHARE_UI_CLEARED:232,MEDIA_SCREENSHARE_CONFIRMBOX_SHOWN:233,MEDIA_SCREENSHARE_CONFIRMBOX_CLEARED:234,MEDIA_SCREENSHARE_POPUP_SHOWN:235,MEDIA_SCREENSHARE_POPUP_CLEARED:236,MEDIA_SCREENSHARE_PLAYER_SHOWN:237,MEDIA_SCREENSHARE_PLAYER_CLEARED:238,MEDIA_SCREENSHARE_SCREEN_PERMISSION_ALLOWED:246,MEDIA_SCREENSHARE_SCREEN_PERMISSION_BLOCKED:247,MEDIA_SCREENSHARE_SHARESCREEN:261,MEDIA_SCREENSHARE_REQUESTSCREEN:262,MEDIA_SCREENSHARE_RECONNECT_STATE:263,MEDIA_SCREENSHARE_RENEGOTIATION_REQUEST:271,MEDIA_SCREENSHARE_RENEGOTIATION_ACCEPT:272,MEDIA_SCREENSHARE_RENEGOTIATION_CANCEL:273,MEDIA_SCREENSHARE_RENEGOTIATION_REJECT:274,MEDIA_SCREENSHARE_RENEGOTIATION_MISS:275,MEDIA_SCREENSHARE_RENEGOTIATION_TRACKADDED:276,MEDIA_SCREENSHARE_RENEGOTIATION_TRACKREMOVED:277}};f.prototype.init=function(e){this.chid=e.chatid,this.mid=e.id,this.type=e.type,this.localDescription="",this.remoteDescription="",this.localStream="",this.remoteStream="",this.localIceCandidates=[],this.remoteIceCandidates=[],this.iceRestart=e.iceRestart,this.isUpStream=e.isUpStream,this.connectionStatus="",this.rtcConnection="",this.isReconnecting=!1,this.remoteCandidatePushed=!1,this.mediaRequest=e.mediaRequest,this.reconnectInterval=null,this.statsObj=null,this.reconnectEndTimer=null,this.audioStream=null,this.screenStream=null,this.remoteStream=[],this.remoteAudioStream=null,this.remoteScreenStream=null,this.screenRtpSenders=null,this.audioRtpSenders=null,this.videoRtpSenders=null,this.isOfferer=!1,this.remoteTracksId=null,this.isNegotiation=!1,this.negotiationType=null,this.streamType={audio:"audioStream",screen_share:"screenStream",video:"videoStream",screen_view:"screenStream"},this.streamData={audio:"audioRtpSenders",screen_share:"screenRtpSenders",screen_view:"screenRtpSenders",video:"videoRtpSenders"},this.currentPerfectRenegotiation=this.container.MediaDetails.getClientSupport().perfect_renegotiation,this.remotePerfectRenegotiation=e.perfectReNegotiation||!0,this.isFirstOfferer=!1,this.istransceiverAdded=!1,this.intRTCConn()},f.prototype.intRTCConn=function(){try{this.rtcConnection=new RTCPeerConnection(this.getCredentail()),this.getStream(),this.isUpStream&&(!this.iceRestart&&this[this.streamType[this.type]]&&this.addStream(),this.isFirstOfferer=!0,this.createOffer(),this[this.curr_connection[this.type]]=!0),this.getRemoteStream(),this.rtcConnectionStatus()}catch(e){}},f.prototype.getStream=function(){this[this.streamType[this.type]]=this.container.MediaPermission.getStreamByType(this.type)},f.prototype.getCredentail=function(){var e=this.mid,t=this.container.dataHandler.get(e+"_credential");if(t.credential){var e=E(t.credential),t=e.servers.split(","),i=e.user_name,n=e.token,a=[];return t.forEach(function(e){a.push({urls:e,username:i,credential:n})}),{iceServers:a}}return null},f.prototype.createOffer=function(){var t=this,e=this.getSDPConstraints();this.iceRestart&&(e.iceRestart=!0),this.rtcConnection.createOffer(e).then(function(e){return t.offerSuccessCallBack(e)}).catch(function(e){return t.offerErrorCallBack(e)})},f.prototype.offerSuccessCallBack=function(e){this.isOfferer=!0,this.localDescription=e,this.rtcConnection.setLocalDescription(new RTCSessionDescription(e));var t={description:e};this.isNegotiation&&(t.tracksId=this.tracksId,t.negotiationType=this.negotiationType,t.processType="negotiation");e=this.contructResponse(t),t=this.type+"Impl";this.container[t].sendOffer(e),this.createIceCandidates()},f.prototype.offerErrorCallBack=function(){},f.prototype.createAnswer=function(){var t=this;this.rtcConnection.createAnswer(this.sdpConstraints).then(function(e){return t.answerSuccessCallBack(e)}).catch(function(e){return t.answerErrorCallBack(e)})},f.prototype.answerSuccessCallBack=function(e){this.localDescription=e,this.rtcConnection.setLocalDescription(new RTCSessionDescription(e));e={description:e};this.negotiationType&&(e.tracksId=this.tracksId,e.negotiationType=this.negotiationType,e.processType="negotiation"),this.container[this.type+"Impl"].sendAnswer(this.contructResponse(e))},f.prototype.addStream=function(){var t=this;this[this.streamType[this.type]]&&this[this.streamType[this.type]].getTracks().forEach(function(e){t[t.streamData[t.type]]="function"==typeof t.rtcConnection.addTrack?t.rtcConnection.addTrack(e,t[t.streamType[t.type]]):t.rtcConnection.addStream(t[t.streamType[t.type]])})},f.prototype.createIceCandidates=function(){var i=this;this.localIceCandidates=[],this.rtcConnection.onicecandidate=function(e){i.localIceCandidates.push(e);var t={};e.candidate&&(t.label=e.candidate.sdpMLineIndex,t.type="candidate",t.id=e.candidate.sdpMid,t.candidate=e.candidate.candidate,t={candidates:i.container.detailsHandler.toJSON(t)},i.container[i.type+"Impl"].sendCandidate(i.contructResponse(t)))}},f.prototype.setRemoteDescription=function(e){var t=this;this.negotiationType&&this.negotiationType==this.audio&&!this.audioRtpSenders&&(this.audioStream=this.container.MediaPermission.getStreamByType("audio"),this.audioRtpSenders=this.addTrack(this.audioStream),this.container.commonImpl.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_RENEGOTIATION_TRACKADDED}})),this.isUpStream||this.isReconnecting||this.iceRestart||!this.audioStream||this.audioRtpSenders||this.addStream(),this.rtcConnection.setRemoteDescription(new RTCSessionDescription(E(e))).then(function(){t.isOfferer||(t.createAnswer(),t.createIceCandidates()),t.clearReconnectNWTimer()}),this.remoteDescription=e,this.remoteCandidatePushed||this.pushIceCandidate(),this.negotiationType&&this.updateRemoteStream()},f.prototype.setOfferRemoteDescription=function(e){this.isOfferer=!1,this.localDescription=null,this.curr_connection.audio=!(!this.remoteTracksId||!this.remoteTracksId[this.audio]),this.curr_connection.screen_share=!(!this.remoteTracksId||!this.remoteTracksId[this.screen_share]),this.tracksId=this.container.MediaPermission.getTracksId(),this.setRemoteDescription(e)},f.prototype.setAnswerRemoteDesription=function(e){this.isOfferer=!0,this.setRemoteDescription(e)},f.prototype.pushIceCandidate=function(){var t=this;this.remoteIceCandidates.forEach(function(e){e=new RTCIceCandidate({sdpMid:e.id,sdpMLineIndex:e.label,candidate:e.candidate});t.rtcConnection.addIceCandidate(e)}),this.remoteCandidatePushed=!0},f.prototype.setIceCandidates=function(e){var t=E(e.candidates||e.msg.candidate);this.remoteDescription&&this.localDescription?(this.remoteIceCandidates&&0<this.remoteIceCandidates.length&&!this.remoteCandidatePushed&&this.pushIceCandidate(),e=new RTCIceCandidate({sdpMid:t.id,sdpMLineIndex:t.label,candidate:t.candidate}),this.rtcConnection.addIceCandidate(e)):(this.remoteIceCandidates&&0<this.remoteIceCandidates.length||(this.remoteIceCandidates=[]),this.remoteIceCandidates.push(t))},f.prototype.rtcConnectionStatus=function(){var i=this;this.rtcConnection.oniceconnectionstatechange=function(){var e,t=i.rtcConnection.iceConnectionState;"connected"==t?(i.remoteIceCandidates=[],i.localIceCandidates=[],i.remoteDescription=null,i.localDescription=null,e=i.type+"Impl",i.container[e].callConnected(i),i.container.commonImpl.clearNetworkTimer(i)):"failed"==t&&i.initReconnect()},this.rtcConnection.onconnectionstatechange=function(e){"failed"==i.rtcConnection.connectionState&&i.initReconnect(),"connected"==i.rtcConnection.iceConnectionState&&(i.remoteIceCandidates=[],i.localIceCandidates=[],i.remoteDescription=null,i.localDescription=null,i.updateRemoteStream())}},f.prototype.initReconnect=function(){this.isReconnecting=!0,this.iceRestart=!0,this.remoteIceCandidates=[],this.remoteDescription=null,this.remoteCandidatePushed=!1,this.container.commonImpl.checkNetwork(this.chid,this.mid)},f.prototype.getRemoteStream=function(){var t=this;this.rtcConnection.onaddstream=this.rtcConnection.ontrack=function(e){t.remoteStream.push(e),e.streams&&e.streams[0]&&t.container[t.type+"Impl"].addRemoteStream(e,t),t.type!=t.screen_share&&"screen_view"!=t.type||t.negotiationType||e.streams&&(e.streams[0].onremovetrack=t.handleScreenTrackremoved),t.negotiationType&&e.streams&&e.streams[0]&&t.updateRemoteStream()}},f.prototype.updateRemoteStream=function(){try{for(var e in this.remoteStream){var t,i=this.remoteStream[e],n=null,n="track"==i.type?i.streams&&i.streams[0]?i.streams[0].id:null:i.stream?i.stream.id:null;for(t in this.remoteTracksId){var a=this.remoteTracksId[t];n&&n===a&&(this.container[t+"Impl"].addRemoteStream(i,this),t==this.screen_share&&i.streams&&i.streams[0]&&(i.streams[0].onremovetrack=this.handleScreenTrackremoved))}}}catch(e){}},f.prototype.handleScreenTrackremoved=function(){SiqAVRouter.container.commonImpl.handleScreenTrackEnd()},f.prototype.contructResponse=function(e){var t=this.mid,i=this.type,n=this.chid;return Object.assign({},{mid:t,type:i,chid:n},e)},f.prototype.closeConnection=function(){try{this.rtcConnection.close(),this[this.streamType[this.type]]&&this.closeTracksInStream(this[this.streamType[this.type]])}catch(e){}},f.prototype.closeTracksInStream=function(e){try{e.getTracks().forEach(function(e){return e.stop()})}catch(e){}},f.prototype.getSDPConstraints=function(){var e=this.type,t=(this.mid,this.chid),i=this.container,n=i.dataHandler,i=i.constants,t=(n.get(t+"_call_status",!0),{offerToReceiveAudio:!0,offerToReceiveVideo:!0});return e==i.audio?t.offerToReceiveVideo=!0:e==i.screen_share&&(t.offerToReceiveVideo=!0,t.offerToReceiveAudio=!0),t},f.prototype.clearReconnectNWTimer=function(){this.reconnectInterval&&(clearInterval(this.reconnectInterval),this.reconnectInterval=null,this.iceRestart=!1)},f.prototype.addAudioTrackInConnection=function(){return!!this.checkIsEligibleToCreateOfferOnNegotiation()&&(this.audioStream=this.container.MediaPermission.getStreamByType(this.audio),this.audioRtpSenders=this.addTrack(this.audioStream),this.container.commonImpl.sendMediaActivity({param:{action_type:v.activity.MEDIA_AUDIO_RENEGOTIATION_TRACKADDED}}),this.isNegotiation=!0,this.negotiationType=this.audio,this.tracksId=this.container.MediaPermission.getTracksId(),this.curr_connection.audio=!0,this.curr_connection.screen_share=!0,this.createOffer(),!0)},f.prototype.addScreenTrackInConnection=function(){return!!this.checkIsEligibleToCreateOfferOnNegotiation()&&(this.screenStream=this.container.MediaPermission.getStreamByType(this.screen_share),this.screenRtpSenders=this.addTrack(this.screenStream),this.container.commonImpl.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_RENEGOTIATION_TRACKADDED}}),this.isNegotiation=!0,this.negotiationType=this.screen_share,this.tracksId=this.container.MediaPermission.getTracksId(),this.curr_connection.audio=!0,this.curr_connection.screen_share=!0,this.createOffer(),this.istransceiverAdded=!0)},f.prototype.removeScreenTrackInConnection=function(){return!!this.checkIsEligibleToCreateOfferOnNegotiation()&&(this.rtcConnection.removeTrack(this.screenRtpSenders),this.container.MediaPermission.closeStreamByType(this.screen_share),this.isNegotiation=!0,this.negotiationType=this.screen_share,this.tracksId=this.container.MediaPermission.getTracksId(),this.curr_connection.audio=!0,this.curr_connection.screen_share=!1,this.screenRtpSenders=null,this.createOffer(),!0)},f.prototype.addTrack=function(t){var i,n=this;return t&&t.getTracks().forEach(function(e){i="function"==typeof n.rtcConnection.addTrack?n.rtcConnection.addTrack(e,t):n.rtcConnection.addStream(t)}),i},f.prototype.checkIsEligibleToCreateOfferOnNegotiation=function(){return!!(this.currentPerfectRenegotiation&&this.remotePerfectRenegotiation||this.isFirstOfferer)},f.prototype.screenShareRenegotiation=function(){this.isNegotiation=!0,this.negotiationType=this.screen_share,this.tracksId=this.container.MediaPermission.getTracksId(),this.istransceiverAdded||(this.rtcConnection.addTransceiver(this.video),this.istransceiverAdded=!0),this.createOffer()},f.prototype.handleScreenShareRenegotiation=function(e,t){void 0===t&&(t=!1),t?(this.rtcConnection.removeTrack(this.screenRtpSenders),this.container.MediaPermission.closeStreamByType(this.screen_share)):(this.screenStream=this.container.MediaPermission.getStreamByType(this.screen_share),this.screenRtpSenders=this.addTrack(this.screenStream),this.container.commonImpl.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_RENEGOTIATION_TRACKADDED}})),this.isNegotiation=!0,this.negotiationType=this.screen_share,this.setOfferRemoteDescription(e)},f.prototype.audioRenegotiation=function(){this.__addAudioTracks(),this.isNegotiation=!0,this.negotiationType=this.audio,this.tracksId=this.container.MediaPermission.getTracksId(),this.createOffer()},f.prototype.handleAudioRenegotiation=function(e){this.__addAudioTracks(),this.isNegotiation=!0,this.negotiationType=this.audio,this.setOfferRemoteDescription(e)},f.prototype.__addAudioTracks=function(){this.audioStream=this.container.MediaPermission.getStreamByType(this.audio),this.audioRtpSenders=this.addTrack(this.audioStream),this.container.commonImpl.sendMediaActivity({param:{action_type:v.activity.MEDIA_AUDIO_RENEGOTIATION_TRACKADDED}})};function e(e){((this.container=e).audioImpl=this).init(),this.audio="audio",this.timeout={},this.iconClicked={},this.reinit=!1,this.isWaitingForPermission=!1}e.prototype.setCredential=function(e){this.container.commonImpl.setCredential(e)},e.prototype.handleInvitation=function(e,t){var i=this;void 0===t&&(t=0);var n=this.container,a=n.constants,o=n.detailsHandler,r=n.commonImpl,s=n.uiHandler,c=e.chatid,d=e.id,l=(e.mode,e.type),p=e.mediaRequest,u=e.isOldUI,h=e.perfectReNegotiation,m=a.RINGTONE_DURATION,g={};if(o.isOldUI()&&(g.is_old_ui=o.isOldUI()),r.endCallFromSameChat({chid:c,id:d}),o.canShowAudioCallInvitation(c))try{var y=r.getActiveCallData();if(o.isembed&&y&&y!=c)return void r.makeCallReject(l,d,null,g);var _=function(){clearTimeout(i.timeout[d]),i.handleUIReject(l,c,d)},f={chid:c,media_id:d,rejectCbk:_,acceptCbk:function(){clearTimeout(i.timeout[d]),i.handleUIAccept(l,c,d,e.mediaInvitation)}};if(r.checkIncomingCallAllowed(e))return r.makeCallReject(l,d,null,g),!0;this.setCredential(e),u&&r.setIsCallInitiatedFromOldUI(u),o.handleIncomingCall({chid:c,type:l}),e.mediaInvitation?(setTimeout(function(){s.handleAudioCallInvite(l,f)},500),r.setCallStatus(c,d,l,"incoming","ringing",p,"downstream",!1,h),y={type:"audiocall",duration:(y=r.getActiveTab())?"3":m,tone:y?"outgoingcall":"incomingcall",chatid:c,isEncrypted:!1},r.playMediaNotificationSound(y),r.sendMediaActivity({param:{action_type:"incomingcall"==y.tone?v.activity.MEDIA_AUDIO_INCOMING_SOUND_START:v.activity.MEDIA_AUDIO_OUTGOING_SOUND_START,add_info:o.getMediaActivityAddInfo()},mid:d}),r.showDesktopNotif({chatid:c}),this.timeout[d]=setTimeout(_,m)):(r.setCallStatus(c,d,l,"incoming","connecting",p,"downstream",!1,h),this.handleUIAccept(l,c,d,e.mediaInvitation)),r.updateIncomingRequestData(e);_="siqMedia: media invitation  | chid :"+c+" | mediaid : "+d+" | curUserId : "+o.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,_),o.triggerIconCheck(c)}catch(e){}else t<3&&(0==t&&o.joinChat(c),setTimeout(function(){return i.handleInvitation(e,t++)},3e3))},e.prototype.handleCallRequest=function(e){var n=this,t=this.container,a=t.commonImpl,o=t.uiHandler,i=t.dataHandler,r=t.MediaPermission,s=t.constants,t=t.detailsHandler,c=e.chatid,d=e.id,l=e.negotiationType,e=e.processType,p=a.getCallStatusByChid(c),u=i.get(c+"_peer")||{},h={process_type:"negotiation",negotiation_type:l};if(t.isOldUI()&&(h.is_old_ui=t.isOldUI()),e&&e==s.reinit)a.getPeerObject(c,d).audioRenegotiation();else try{var m=function(){clearTimeout(n.timeout[d]),o.updateCallInvitationState("audio",{chid:c,media_id:d},"rejected"),a.makeCallReject(l,d,null,h)},g={chid:c,media_id:d,rejectCbk:m,acceptCbk:function(){clearTimeout(n.timeout[d]);var e={chid:c,media_id:d,isDirectCall:p[d].isdirectcall,muteCbk:function(){return n.toggleMute()},rejectCbk:function(){return a.makeCallReject(l,d,null,h)}},t=function(){clearTimeout(i)},i=setTimeout(function(){t=o.mediaPermissionUI()},3e3);a.sendMediaActivity({param:{action_type:v.activity.MEDIA_AUDIO_RENEGOTIATION_ACCEPT},mid:d}),r.getAudioStream(function(){t(),a.sendMediaActivity({param:{action_type:v.activity.MEDIA_AUDIO_MIC_PERMISSION_ALLOWED},mid:d}),o.updateCallInvitationState("audio",e,"connecting"),a.makeCallAccept(l,d,null,h),u[d].addAudioTrackInConnection()||n.handleInitReNegotiation({chatid:c,id:d,negotiationType:"audio"})},n.onDownStreamMediaPermissionFailureSecondary({chatid:c,id:d,cbk:t}))}};this.timeout[d]=setTimeout(m,65e3),o.handleAudioCallInvite(l,g)}catch(e){}},e.prototype.callConnected=function(e){var t=this,i=e.chid,n=e.type,a=e.mid,o=(e.isReconnecting,this.container),r=o.commonImpl,s=o.dataHandler,c=o.uiHandler,d=o.detailsHandler,l=r.getCallStatusByChid(i)[a].isdirectcall,e=(e=localStorage.getItem("siq_directcall"))&&E(e);clearTimeout(s.get(a+"_connecting_timer"));o={chid:i,callEndCbk:l?function(){return t.handleUIApiCallEnd(i,n,a)}:function(){r.makeCallEnd(n,a),t.handleCallEnd({chatid:i,type:n,id:a})},muteCbk:function(){return t.toggleMute()},media_id:a,isDirectCall:l};c.updateCallInvitationState("audio",o,"connected"),r.updateCallStatus(i,a,"connected"),r.getEligibleMediaAction(i,n),d.triggerIconCheck(i),r.sendMediaStats({id:a},"call connected ");d="siqMedia: Audio call connected  | chid :"+i+" | mediaid : "+a+" | curUserId : "+d.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,d);s=s.get(i+"_peer");s&&s[a]&&s.reconnectEndTimer&&clearTimeout(s.reconnectEndTimer),e&&l&&(e.status="connected",localStorage.setItem("siq_directcall",R(e))),r.updateMediaStatsDetail({connectedTime:Date.now(),isreconnected:!1,mediaid:a});e=r.getConnectedStatsDetail(a);r.makeCallConnected(e),r.stopNotificationSound()},e.prototype.handleCallAccept=function(e){var t=this,i=e.chatid,n=e.id,a=e.type,o=e.processType,r=e.isOldUI,s=this.container,c=s.dataHandler,d=s.constants,l=s.commonImpl,p=s.uiHandler,u=s.detailsHandler,h=d.WAITING_TIME,m=i+"_peer",s=c.get(m)||{},g=l.getCallStatusByChid(i);if(clearTimeout(c.get(n+"_waiting_timer")),c.remove(n+"_waiting_timer"),u.handleOutgoingAccept({chid:i,type:a}),!o||o!=d.negotiation){r&&l.setIsCallInitiatedFromOldUI(r);e.isUpStream=!0,e.iceRestart=!1,s[n]=new f(e,this.container),c.set(m,s),l.updateCallStatus(i,n,"connecting"),c.set(n+"_connecting_timer",setTimeout(function(){l.makeCallEnd(a,n),t.clearData({type:a,chatid:i,id:n}),p.updateCallInvitationState("audio",{chid:i,media_id:n},"ended")},h));var y={};u.isOldUI()&&(y.is_old_ui=u.isOldUI());h={chid:i,media_id:n,isDirectCall:g[n].isdirectcall,muteCbk:function(){return t.toggleMute()},rejectCbk:function(){return"upstream"==g[n].host?l.makeCallCancel(a,n,null,y):l.makeCallReject(a,n,null,y)}};p.updateCallInvitationState("audio",h,"connecting"),l.stopNotificationSound(),l.sendMediaActivity({param:{action_type:v.activity.MEDIA_AUDIO_SOUND_STOP,add_info:u.getMediaActivityAddInfo()},mid:n});try{var _={acceptedTime:Date.now(),callerType:0,lsid:u.getLsid(i),reconnectCount:0,type:a,mediaid:n};l.setMediaStatsDetail(_)}catch(e){}h="siqMedia: call accept request received  | chid :"+i+" | mediaid : "+n+" | curUserId : "+u.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,h)}},e.prototype.handleCallReject=function(e){var t=e.chatid,i=e.id,n=e.processType,a=this.container,o=a.commonImpl,r=a.uiHandler,s=a.dataHandler,c=a.detailsHandler,d=a.constants,l=o.getCallStatusByChid(t),a={chid:t,media_id:i,isDirectCall:l[i].isdirectcall,lsuid:E(e.opruser).lsuid,process_type:n};delete this.iconClicked[t],clearTimeout(s.get(i+"_waiting_timer")),clearTimeout(s.get(i+"_connecting_timer")),r.updateCallInvitationState("audio",a,"rejected"),l[i].isdirectcall&&localStorage.removeItem("siq_directcall"),n&&n==d.negotiation||(this.clearData(e),delete l[i],o.removeCredential(i),c.handleCallRejected({type:"audio",chid:t}),c="siqMedia: call reject request received  | chid :"+t+" | mediaid : "+i+" | curUserId : "+c.getCurrentUserId(),this.callBackAction(this.implConstants.postDebugLog,c))},e.prototype.handleCandidates=function(e){var t=this.container,i=t.dataHandler,n=t.commonImpl,t=i.get(e.chatid+"_peer")[e.id];t||((t={})[e.id]=new f(e,this.container),i.set(e.chatid+"_peer",t),t=t[e.id],n.setRemotePerfectReNegotiation(t,e.id,e.chatid)),t.setIceCandidates(e)},e.prototype.handleCallAnswer=function(e){e.chatid;var t=e.id,i=e.session,n=e.tracksId,a=e.negotiationType,t=this.container.dataHandler.get(e.chatid+"_peer")[t];t.remoteTracksId=n?JSON.parse(n):null,t.negotiationType=a||null,t.setAnswerRemoteDesription(i)},e.prototype.handleCallEnd=function(e){var t=this.container,i=t.commonImpl,n=t.uiHandler,a=t.detailsHandler,o=(t.constants,t.screenShareImpl),t=(e.processType,i.getCallStatusByChid(e.chatid)),i={chid:e.chatid,media_id:e.id,isDirectCall:t[e.id].isdirectcall};n.updateCallInvitationState("audio",i,"ended"),t[e.id].isdirectcall&&localStorage.removeItem("siq_directcall"),o.handleAudioCallEnd(e.chatid),this.clearData(e),a.handleCallEnded({type:"audio",chid:e.chatid})},e.prototype.handleCallOffer=function(e){var t=e.chatid,i=e.id,n=e.session,a=e.tracksId,o=e.negotiationType,r=this.container,s=r.dataHandler,c=r.constants,d=r.MediaPermission,l=r.commonImpl,r=t+"_peer",r=s.get(r)||{};d.getStreamByType(c.screen_share)&&o==c.screen_share&&s.set(c.isAlreadySharing,!0),e.isUpStream=!1,e.iceRestart=!1;c=r[i];r[i]||(r[i]=new f(e,this.container),s.set(t+"_peer",r),c=r[i]),c.remoteTracksId=a?JSON.parse(a):null,c.negotiationType=o||null,l.setRemotePerfectReNegotiation(c,i,t),this.reinit?c.handleAudioRenegotiation(n):c.setOfferRemoteDescription(n),this.reinit=!1},e.prototype.handleCallCancel=function(e){try{var t=e.chatid,i=e.id,n=e.type,a=e.processType,o=this.container,r=o.commonImpl,s=o.uiHandler,c=o.dataHandler,d=o.detailsHandler,l=o.constants,o={chid:t,media_id:i,isDirectCall:r.getCallStatusByChid(t)[i].isdirectcall};if(clearTimeout(this.timeout[i]),clearTimeout(c.get(i+"_waiting_timer")),clearTimeout(c.get(i+"_connecting_timer")),s.updateCallInvitationState("audio",o,"cancelled"),a&&a==l.negotiation)return;r.removeCredential(i);i="siqMedia: call cancel request received  | chid :"+t+" | mediaid : "+i+" | curUserId : "+d.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,i),this.clearData(e),d.handleCallCancelled({type:n,chid:t})}catch(e){}},e.prototype.clearData=function(e){try{var t=this.container,i=t.detailsHandler,n=t.commonImpl,a=e.type,o=e.chatid||e.chid,r=e.id||e.mid,t="siqMedia: before clearing Audio call data  | chid :"+o+" | mediaid : "+r+" | curUserId : "+i.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,t),n.deleteIsCallInitiatedFromOldUI(),this.closePeerConn(e),n.removeCredential(r),n.checkAVIcon(o),n.clearCallDetails(o,r),n.getActiveCallData()&&n.getActiveCallData()==o&&!n.getCallStatusByChid(o)&&(n.removeActiveCallData(),n.removeActiveTab(),this.clearMediaPermision(a)),n.removeIncomingRequestData({chid:o,id:r}),n.stopNotificationSound(),n.checkAndPlayNotification(),i.triggerIconCheck(o),n.clearConnectedStatsDetail(r)}catch(e){}},e.prototype.handleCallInvite=function(){},e.prototype.closePeerConn=function(e){var t=this.container,i=t.dataHandler,n=t.detailsHandler,a=t.commonImpl,o=e.chatid||e.chid,r=e.id||e.mid,s=e.type;try{var c=i.get(o+"_peer"),d=c[r];a.clearNetworkTimer(d),d.closeConnection(),delete c[r],this.clearMediaPermision(s),this.removeAudioPlayer()}catch(e){n="siqMedia: error while clearing peer connection  | chid :"+o+" | mediaid : "+r+" | curUserId : "+n.getCurrentUserId()+" | error msg :"+e;this.callBackAction(this.implConstants.postDebugLog,n)}},e.prototype.clearMediaPermision=function(e){this.container.MediaPermission.closeStreamByType(e)},e.prototype.startAudioCall=function(e){var t=this,i=this.container,n=i.commonImpl,a=i.detailsHandler,o=i.uiHandler,r=i.MediaPermission,s=i.MediaDetails,i=n.getActiveCallData();if((!i||i==e.chatid||a.isEmbed())&&!this.iconClicked[e.normalchid||e.chatid]){if(this.iconClicked[e.normalchid||e.chatid]=!0,a.isoldUI&&(e.is_old_ui=a.isoldUI),e.perfect_renegotiation=s.getClientSupport().perfect_renegotiation,i){var c,d=n.getCallStatusByChid(i);for(c in d)if("audio"==d[c].type)return void delete this.iconClicked[e.normalchid||e.chatid]}try{var l=e.chatid,p=a.isembed;if("visitor"!=e.mode||(!!p||this.isAudioCallAllowed(e))){if(a.isAudioCallDisabled(l))return void delete this.iconClicked[e.normalchid||e.chatid];var u=function(){clearTimeout(h)},h=setTimeout(function(){u=o.mediaPermissionUI()},3e3);this.isWaitingForPermission=!0,r.getAudioStream(function(){u(),t.onMediaPermissionSuccess(e).call(t)},this.onUpStreamMediaPermissionFailure(function(){return u()},l))}else{l="siqMedia: To start AUDIO call - permission checks failed | chid - "+l+" ";this.callBackAction(this.implConstants.postDebugLog,l),delete this.iconClicked[e.normalchid||e.chatid]}}catch(e){}}},e.prototype.constructResponeObj=function(e){return Object.assign({},{type:"audio"},e)},e.prototype.onMediaPermissionSuccess=function(i){var n=this;try{var e=this.container,t=e.constants,a=e.commonImpl,o=e.ajaxHandler,e=e.MediaPermission,r=(t.WAITING_TIME_SECS,i.normalchid||i.chatid),s=a.getCallStatusByChid(r);if(i.mode=i.mode||"visitor",!this.isCallAllowed(r))return e.closeStreamByType("audio"),delete this.iconClicked[r],function(){n.isWaitingForPermission=!1};var c=this.constructResponeObj(i);a.setActiveTab(),c.mediainvitation=i.mediainvitation||!1,c.mediarequest=i.mediarequest||!1;var d=a.constructURL(null,null);return a.setActiveCallData(r),a.sendMediaActivity({param:{action_type:v.activity.MEDIA_AUDIO_MIC_PERMISSION_ALLOWED}}),function(){n.isWaitingForPermission=!1;var e,t=n.onstarted.bind(n);s&&(c={},e=Object.keys(s)[0],d=a.constructURL("audio",e),t=function(){return n.onstartedSecondary({chid:r,id:e,negotiationType:"audio"})}),delete i.normalchid,o.post(d,c,t,n.startCallFailure.bind(n))}}catch(e){}},e.prototype.onUpStreamMediaPermissionFailure=function(i,n){var a=this,e=this.container,o=e.commonImpl,r=e.uiHandler;return function(e,t){o.sendMediaActivity({param:{action_type:v.activity.MEDIA_AUDIO_MIC_PERMISSION_BLOCKED}}),i(),a.isWaitingForPermission=!1;e=o.getFailureMessage(e);r.mediaPermissionUnlock(),r.showDialog({desc:e,buttons:{accept:{text:"common.ok",callback:function(){return null}}}}),delete a.iconClicked[n]}},e.prototype.onDownStreamMediaPermissionFailure=function(a){var o=this,e=this.container,r=e.commonImpl,s=e.uiHandler,c=e.detailsHandler;return function(e,t){try{r.sendMediaActivity({param:{action_type:v.activity.MEDIA_AUDIO_MIC_PERMISSION_BLOCKED},mid:a.id}),a.cbk(),s.mediaPermissionUnlock();var i=r.getFailureMessage(e),n={};c.isOldUI()&&(n.is_old_ui=c.isOldUI()),r.makeCallReject("audio",a.id,null,n),o.clearData({type:"audio",chatid:a.chatid,id:a.id}),r.removeActiveTab(),s.updateCallInvitationState("audio",{chid:a.chatid,media_id:a.id},"rejected"),s.showDialog({desc:i,buttons:{accept:{text:"common.ok",callback:function(){return null}}}})}catch(e){}}},e.prototype.onDownStreamMediaPermissionFailureSecondary=function(n){var e=this.container,a=e.commonImpl,o=e.uiHandler,e=e.detailsHandler,r={process_type:"negotiation",negotiation_type:"audio"};return e.isOldUI()&&(r.is_old_ui=e.isOldUI()),function(e,t){try{a.sendMediaActivity({param:{action_type:v.activity.MEDIA_AUDIO_MIC_PERMISSION_BLOCKED},mid:n.id}),n.cbk(),o.mediaPermissionUnlock();var i=a.getFailureMessage(e);a.makeCallReject("audio",n.id,null,r),o.updateCallInvitationState("audio",{chid:n.chatid,media_id:n.id},"rejected"),o.showDialog({desc:i,buttons:{accept:{text:"common.ok",callback:function(){return null}}}})}catch(e){}}},e.prototype.isAudioCallAllowed=function(t){var e=this.container,i=e.commonImpl,n=e.uiHandler,a=e.detailsHandler,o=e.MediaDetails,r=t.chatid;try{var s=a.getVisitorBrowser(r),c=a.getVisitorPage(r),d=!0,l="",p="";return i.getMediaDataByChidAndType({chatid:r,type:this.audio})?!1:(a.isChatMonitor(r)?(p="AUDIO - call Not Allowed because chat is in monitor | chid - "+r+" | visitorId - ",l=a.I18N("av.info.chatinvite"),d=!1):"Google Chrome"!==s&&"Mozilla Firefox"!==s&&"Apple Safari"!==s&&"Opera"!==s?(l=a.I18N("av.info.visitorbrowsernotsupported"),p="AUDIO call - Failed visitor browser not supported | chid - "+r+" | visitorId -  | browser-"+s,d=!1):o.checkBrowserSupported()?"https"!=c.substring(0,5)?(l=a.I18N("av.info.insecuredwebsite"),p="AUDIO call-Failed Visitor not in secure connection | chid - "+r+" |  visitorId - ",d=!1):a.isGroupConversation(r)?(l=a.I18N("av.info.chatinvite"),p="AUDIO call-Failed Visitor not in secure connection | chid - "+r+" |  visitorId - ",d=!1):a.isAttenderBot(r)?(p="AUDIO call-Failed bot attender | chid - "+r+" |  visitorId - ",d=!1):a.isFaceBookIntegration(r)&&(l=a.I18N("av.info.facebookpagenotsupported"),p="AUDIO call-Failed Visitor is in Facebook page | chid - "+r+" |  visitorId - ",d=!1):(p="AUDIO call-Failed agent browser not supported| chid - "+r,d=!1),d||(n.showDialog({desc:l,buttons:{accept:{text:"common.ok",callback:function(){return null}}}}),this.callBackAction(this.implConstants.postDebugLog,p)),d)}catch(e){t="failed in isAudioCallAllowed method | chid - "+r;this.callBackAction(this.implConstants.postDebugLog,t)}},e.prototype.sendOffer=function(e){this.container.commonImpl.sendOffer(e)},e.prototype.sendAnswer=function(e){this.container.commonImpl.sendAnswer(e)},e.prototype.sendCandidate=function(e){this.container.commonImpl.sendCandidate(e)},e.prototype.postDebugLog=function(e){this.container.detailsHandler.sendDebugLogger(e,null,null,!0)},e.prototype.callBackAction=function(e,t){({postDebugLog:this.postDebugLog.bind(this)})[e](t)},e.prototype.init=function(){this.implConstants={postDebugLog:"postDebugLog"}},e.prototype.addRemoteStream=function(e,t){var i=this,n=this.container,a=n.detailsHandler,o=n.commonImpl,r=n.uiHandler;try{var s="siqMedia: adding remote stream  | chid :"+t.chid+" | mediaid : "+t.mid+" | lsuid : "+a.getCurrentUserId();r.updateCallInvitationState("audio",{chid:t.chid,id:t.mid,callEndCbk:function(){i.handleUIEnd("audio",t.chid,t.mid)}},"connected"),this.callBackAction(this.implConstants.postDebugLog,s);var c="",d=e.stream;t.type!=this.audio&&t.negotiationType!=this.audio||(c=this.addAudioPlayer()),e.streams&&(d=e.streams[0]);try{c.srcObject=d}catch(e){c.src=window.URL.createObjectURL(d)}o.checkAndUpdateUIForApi()}catch(e){n="siqMedia: adding remote stream  | chid :"+t.chid+" | mediaid : "+t.mid+" | lsuid : "+a.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,n)}},e.prototype.addAudioPlayer=function(){try{var e="siqMedia: creating audio player stream  | curUserId : "+this.container.detailsHandler.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,e);e=document.querySelector("#remoteaudio");if(null!=e&&null!=e&&0!=e.length)return e[0];e=document.createElement("audio");return e.id="remoteaudio",e.autoplay=!0,document.querySelector("body").appendChild(e),e}catch(e){}},e.prototype.removeAudioPlayer=function(){var e=document.querySelector("#remoteaudio");e.parentNode.removeChild(e)},e.prototype.startCallFailure=function(){this.iconClicked={},callBackAction()},e.prototype.startcall=function(e,t,i){var n={},a=this.container,o=a.ajaxHandler,a=a.commonImpl;n.type=e,n.chatid=t,n.mode=i||"visitor";i=a.constructURL(null,null);a.setActiveCallData(t),o.post(i,n,this.onstarted,this.startCallFailure)},e.prototype.handleUIReject=function(e,t,i){var n=this.container,a=n.commonImpl,o=n.uiHandler,r=n.detailsHandler,n=a.getCallStatusByChid(t);o.updateCallInvitationState("audio",{chid:t,media_id:i,isDirectCall:n[i].isdirectcall},"rejected");n={};r.isOldUI()&&(n.is_old_ui=r.isOldUI()),a.makeCallReject(e,i,null,n),this.clearData({type:e,chatid:t,id:i}),r.handleCallRejected({type:e,chid:t});r=" reject trigger from UI | chid :"+t+" | mediaid : "+i+" | curUserId : "+r.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,r)},e.prototype.handleUIEnd=function(e,t,i){var n=this.container,a=n.commonImpl,o=n.uiHandler,r=n.detailsHandler,s=n.screenShareImpl,c=a.getCallStatusByChid(t);try{var d={chid:t,media_id:i,isDirectCall:c[i].isdirectcall};a.makeCallEnd(e,i),o.updateCallInvitationState("audio",d,"ended"),r.triggerIconCheck(t),this.clearData({type:e,chatid:t,id:i}),s.handleAudioCallEnd(t),this.container.detailsHandler.handleCallEnded({type:e,chid:t})}catch(e){}},e.prototype.endOngoingCall=function(e,t,i){try{var n=this.container,a=n.dataHandler,o=n.uiHandler,r=n.commonImpl,s=n.screenShareImpl,n=n.detailsHandler,c=a.get(e+"_peer");if(s.handleAudioCallEnd(e),c)for(var d in c){var l=c[d];o.updateCallInvitationState(l.type,{chid:e,media_id:l.mid},"ended"),r.makeCallEnd(l.type,l.mid,i),this.clearData(l),delete c[d]}else r.makeCallEnd("audio",t,i),this.clearData({type:"audio",chatid:e,id:t});r.stopNotificationSound(),r.sendMediaActivity({param:{action_type:v.activity.MEDIA_AUDIO_SOUND_STOP,add_info:n.getMediaActivityAddInfo()},mid:t}),r.removeActiveCallData(e)}catch(e){}},e.prototype.__handleUIAccept=function(t,i,n){var a=this,e=this.container,o=e.commonImpl,r=e.detailsHandler,s=e.uiHandler,c=e.MediaPermission,d=e.dataHandler,l=e.constants,p=e.MediaDetails,u=o.getActiveCallData(),h=o.getCallStatusByChid(u),m=o.getCallStatusByChid(i);if(r.isOldUI()&&r.focusChatWindow(i),u&&u!=i)for(var g in h)!function(e){var t=h[e],i=t.type+"Impl",n=t.callStatus;"connected"==n?a.container[i].endOngoingCall(u,e,function(){return t.isdirectcall&&r.endSession(u)}):"ringing"!=n&&"connecting"!=n||(("upstream"==h[e].host?a.container[i].handleUICancel:a.container[i].handleUIReject).bind(a)(t.type,u,t.id),o.removeActiveCallData())}(g);var y=function(){clearTimeout(_)},_=setTimeout(function(){y=s.mediaPermissionUI()},3e3);c.getAudioStream(function(){y(),o.sendMediaActivity({param:{action_type:v.activity.MEDIA_AUDIO_MIC_PERMISSION_ALLOWED},mid:n}),o.updateCallStatus(i,n,"connecting"),o.setActiveCallData(i);var e={};r.isoldUI&&(e.is_old_ui=r.isoldUI),e.perfect_renegotiation=p.getClientSupport().perfect_renegotiation,o.makeCallAccept("audio",n,null,e);e={chid:i,media_id:n,muteCbk:function(){return a.toggleMute()},rejectCbk:function(){return"upstream"==m[n].host?a.handleUICancel(t,i,n):a.handleUIReject(t,i,n)}};s.updateCallInvitationState("audio",e,"connecting");e=l.WAITING_TIME;d.set(n+"_connecting_timer",setTimeout(function(){o.makeCallEnd(t,n),a.clearData({type:t,chatid:i,id:n}),s.updateCallInvitationState("audio",{chid:i,media_id:n},"ended"),o.sendMediaActivity({param:{action_type:v.activity.MEDIA_AUDIO_INVITATION_CLEARED,add_info:r.getMediaActivityAddInfo()},mid:n})},e))},this.onDownStreamMediaPermissionFailure({chatid:i,id:n,cbk:y})),o.removeIncomingRequestData({chid:i,id:n}),o.setActiveTab(),o.stopNotificationSound(),o.sendMediaActivity({param:{action_type:v.activity.MEDIA_AUDIO_SOUND_STOP,add_info:r.getMediaActivityAddInfo()},mid:n})},e.prototype.handleUIAccept=function(e,t,i,n){var a=this,o=this.container,r=o.detailsHandler,s=o.uiHandler,c=o.commonImpl,o=c.getActiveCallData();this.isWaitingForPermission||(o&&o!=t?s.handleCallClash(function(){return a.__handleUIAccept(e,t,i,n)},function(){return a.handleUIReject(e,t,i)}):this.__handleUIAccept(e,t,i,n),s={acceptedTime:Date.now(),callerType:1,lsid:r.getLsid(t),reconnectCount:0,type:e,mediaid:i},c.setMediaStatsDetail(s),r.handleIncomingAccept({chid:t,type:e}))},e.prototype.handleUICancel=function(e,t,i){var n=this.container,a=n.detailsHandler,o=n.uiHandler,r=n.commonImpl,n=n.dataHandler;o.updateCallInvitationState(e,{chid:t,media_id:i},"cancelled");o={};a.isOldUI()&&(o.is_old_ui=a.isOldUI()),r.makeCallCancel(e,i,null,o),this.clearData({type:e,chatid:t,id:i}),a.handleCallCancelled({type:e,chid:t}),clearTimeout(this.timeout[i]),clearTimeout(n.get(i+"_waiting_timer")),clearTimeout(n.get(i+"_connecting_timer")),n.remove(i+"_waiting_timer"),a.clearPlayer()&&r.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_PLAYER_CLEARED,add_info:a.getMediaActivityAddInfo()},mid:i});a=" cancel trigger from UI | chid :"+t+" | mediaid : "+i+" | curUserId : "+a.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,a)},e.prototype.toggleMute=function(){this.container.MediaPermission.toggleMute()},e.prototype.startVisitorAudioCall=function(e){e={chatid:e,mode:"visitor",mediarequest:!0,mediainvitation:!0,type:"audio"};this.startAudioCall(e)},e.prototype.handleCallMissed=function(e){var t=this.container,i=t.detailsHandler,n=t.uiHandler,a=t.constants;try{var o=e.chatid,r=e.id,s=e.processType;delete this.iconClicked[o];var c={chid:o,media_id:r};if(clearTimeout(this.timeout[r]),n.updateCallInvitationState("audio",c,"missed"),s&&s==a.negotiation)return;this.clearData(e),i.handleCallMissed({type:"audio",chid:o})}catch(e){t=" call missed  | chid :"+chatid+" | mediaid : "+id+" | curUserId : "+i.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,t)}},e.prototype.acceptAudioCallForDsk=function(e){var t=this.container,i=t.commonImpl,t=t.uiHandler,i=i.getMediaDataByChidAndType({chatid:e,type:this.audio}).id;this.__handleUIAccept(this.type,e,i,!0),t.clearAudioCallInvite(this.audio,i)},e.prototype.rejectAudioCallForDsk=function(e){var t=this.container,i=t.commonImpl,t=t.uiHandler,i=i.getMediaDataByChidAndType({chatid:e,type:this.audio}).id;this.handleUIReject(this.type,e,i),t.clearAudioCallInvite(this.audio,i)},e.prototype.hasIncommingCall=function(e){var t,i=this.container.commonImpl.getActiveCallData(),n=this.container.commonImpl.getCallStatusByChid(e);for(t in n){var a=n[t];if("audio"==a.type&&"incoming"==a.callType&&"ringing"==a.callStatus||i==e)return!0}return!1},e.prototype.handleCallRequestSuccesCbk=function(e){e.mid,e.chid},e.prototype.initCallRequest=function(e){var t=e.mid,i=e.negotiationType,n=e.chid,a=this.container,o=a.commonImpl,r=a.ajaxHandler,s=a.dataHandler,c=a.constants,d=a.uiHandler,l=a.screenShareImpl,e=a.detailsHandler,a=o.constructURL("screenshare",t),p={negotiation_type:i,process_type:c.negotiation};e.isOldUI()&&(p.is_old_ui=e.isOldUI());s.set(t+"_connecting_timer",setTimeout(function(){o.makeCallMissed("screenshare",t,null,p);var e=d.states[n];e&&e.screen_share&&"sharing"!=e.screen_share.type&&!o.getSwapRequestCallbackState()?(d.updateCallInvitationState("screenshare",{chid:n,media_id:t},"requestMissed"),d.deleteScreenShareState(n)):o.getSwapRequestCallbackState()&&l.handlingRequestStateOnSwap(n,t,"requestMissed")},c.WAITING_TIME)),r.post(a,{},null,null)},e.prototype.addScreenShareTrack=function(e){var t=e.chid,e=(e.id,this.container),i=e.commonImpl,n=e.screenShareImpl,a=e.MediaPermission,o=e.uiHandler,r=e.constants,e=i.getCallStatusByChid(t),s=Object.keys(e)[0],c=i.getPeerObject(t,s);this.container.MediaPermission.getScreenShareStream(function(){c.addScreenTrackInConnection()||n.handleInitReNegotiation({chatid:t,id:s,negotiationType:"screen_share"});var e=o.states[t];e.screen_share=e.screen_share||{};e=function(){return n.handleUIEnd({chatid:t,type:r.screen_share,id:s})};o.makeScreenShareConnected(r.screen_share,{media_id:s,chid:t,callEndCbk:e,ss_type:r.sharing}),a.screenEndFromBrowserUI(e),i.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_SCREEN_PERMISSION_ALLOWED},mid:s})},function(){i.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_SCREEN_PERMISSION_BLOCKED},mid:s})})},e.prototype.handleAudioCallEnd=function(e){var t=this.container,i=t.uiHandler,n=t.MediaPermission,a=t.commonImpl,o=t.detailsHandler,r=e.chatid,t=e.id,e=a.getCallStatusByChid(r);n.closeStreamByType("audio"),i.clearAudioCallInvite("audio",t);e={chid:r,media_id:t,isDirectCall:!(!e||!e[t])&&e[t].isdirectcall};i.updateCallInvitationState("audio",e,"ended"),i.stopTimer(r),i.clearAllStates(r),o.clearAudioUI(),o.clearPlayer()&&a.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_PLAYER_CLEARED,add_info:o.getMediaActivityAddInfo()},mid:t}),o.clearPopup()&&a.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_POPUP_CLEARED,add_info:o.getMediaActivityAddInfo()},mid:t})},e.prototype.isCallAllowed=function(e){for(var t=this.container,i=t.dataHandler,n=t.detailsHandler,a=i.get("media_inv"),o=0;a&&a.length>o;o++)if(a[o][e=n.isembed?n.getChatWinObjById(e,!0).RCHID:e])return!1;return!0},e.prototype.handleInitReNegotiation=function(e){e.chatid;var t=e.id,i=(e.processType,e.negotiationType,this.container),e=i.commonImpl,i=i.ajaxHandler,t=e.constructURL("audio",t);this.reinit=!0;i.post(t,{process_type:"reinit"},function(){},null)};function i(e){e.videoImpl=this}i.prototype.handleInvitation=function(){},i.prototype.handleCallAccept=function(){},i.prototype.handleCallReject=function(){},i.prototype.handleCandidates=function(){},i.prototype.handleCallAnswer=function(){},i.prototype.handleCallEnd=function(){},i.prototype.handleCallOffer=function(){},i.prototype.handleCallCancel=function(){},i.prototype.handleCallCancel=function(){},i.prototype.handleCallInvite=function(){};function n(e){e.screenShareImpl=this,(e.screen_viewImpl=this).container=e,this.timeout={},this.init(),this.reinit=!1,this.removeTrackOnReNegotiation=!1}n.prototype.setCredential=function(e){this.container.commonImpl.setCredential(e)},n.prototype.handleInvitation=function(e){var t=this,i=e.chatid,n=e.id,a=e.type,o=e.perfectReNegotiation,r=this.container,s=r.commonImpl,c=r.uiHandler,d=r.MediaPermission,l=r.detailsHandler,p=r.MediaDetails;s.endCallFromSameChat({chid:i,id:n}),l.isEmbed()&&l.clearBusyUI();function u(e){void 0===e&&(e=!0),clearTimeout(t.timeout[n]),e?t.handleUIAccept(a,i,n):t.handleUIReject(a,i,n)}function h(){return u(!1)}var m,g={chid:i,media_id:n,rejectCbk:h,acceptCbk:u},r={};if(l.isOldUI()&&(r.is_old_ui=l.isOldUI()),s.checkIncomingCallAllowed(e))return s.makeCallReject(a,n,null,r),!0;s.setScreenShareRequestData(i),this.setCredential(e),e.mediaInvitation?(c.handleAudioCallInvite("screen_share",g),s.setCallStatus(i,n,a,"incoming","ringing",e.mediaRequest,"downstream",!1,o),this.timeout[n]=setTimeout(h,65e3)):(m={perfect_renegotiation:p.getClientSupport().perfect_renegotiation},s.setCallStatus(i,n,a,"incoming","connecting",e.mediaRequest,"downstream",!1,o),e.mediaRequest?d.getScreenShareStream(function(){s.isScreenRequestPending(i)&&(s.makeCallAccept("screen_share",n,null,m),d.screenEndFromBrowserUI(function(){return t.handleUIEnd({type:a,id:n,chatid:i})}),s.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_SCREEN_PERMISSION_ALLOWED},mid:n}))},this.onMediaPermissionFailure(i,n)):(s.setActiveCallData(i),setTimeout(function(){s.makeCallAccept("screen_share",n,null,m)},2e3)),s.setActiveTab(),l.triggerIconCheck(i)),l.handleIncomingCall({chid:i,type:a})},n.prototype.handleAcceptSuccessCbk=function(e,t){var i=this.container.dataHandler,n=this.container.constants.screen_share,a=e+"_peer",o=i.get(a)||{},n={chatid:e,id:t,type:n,iceRestart:!1,isUpStream:!0,mediaRequest:!0};o[t]=new f(n,this.container),i.set(a,o)},n.prototype.handleCallAccept=function(e){var t=this,i=e.chatid,n=e.id,a=e.type,o=e.processType,r=this.container,s=r.dataHandler,c=r.commonImpl,d=r.constants,l=r.uiHandler,p=r.detailsHandler;if(o&&o==d.negotiation)return c.clearConnectingTimer(n),c.clearMissedCallTimeout(n),l.deleteScreenShareState(i),void c.deleteSwapRequestCallbackState();r=i+"_peer",o=s.get(r)||{};e.isUpStream=!0,e.iceRestart=!1,a==d.screen_share&&(o[n]=new f(e,this.container),s.set(r,o)),clearTimeout(s.get(n+"_waiting_timer")),s.remove(n+"_waiting_timer");var u={};p.isOldUI()&&(u.is_old_ui=p.isOldUI());p={chid:i,media_id:n,muteCbk:function(){},rejectCbk:function(){c.makeCallCancel(a,n,null,u),l.updateCallInvitationState(a,{chid:i,media_id:n},"cancelled"),t.clearData(e)}};c.updateCallStatus(i,n,"connecting"),l.updateCallInvitationState(d.screen_share,p,d.connecting)},n.prototype.handleCallReject=function(e){var t=e.chatid,i=e.id,n=e.type,a=e.processType,o=this.container,r=o.detailsHandler,s=o.uiHandler,c=o.constants,o=o.commonImpl;if(a&&a==c.negotiation)return o.getSwapRequestCallbackState()?this.handlingRequestStateOnSwap(t,i,"requestRejected"):"requested"==s.states[t][c.screen_share].status&&this.container.uiHandler.updateCallInvitationState("screen_share",{chid:t,media_id:i},"rejected"),o.clearMissedCallTimeout(i),void o.clearConnectingTimer(i);this.container.uiHandler.updateCallInvitationState("screen_share",{chid:t,media_id:i},"rejected"),this.clearData(e),r.handleCallRejected({type:n,chid:t})},n.prototype.handleCandidates=function(e){var t=this.container,i=t.dataHandler,n=t.commonImpl,t=i.get(e.chatid+"_peer")[e.id];t||((t={})[e.id]=new f(e,this.container),i.set(e.chatid+"_peer",t),t=t[e.id],n.setRemotePerfectReNegotiation(t,e.id,e.chatid)),t.setIceCandidates(e)},n.prototype.handleCallAnswer=function(e){e.chatid;var t=e.id,i=e.session,n=e.tracksId,a=e.negotiationType,t=this.container.dataHandler.get(e.chatid+"_peer")[t];t.remoteTracksId=n?JSON.parse(n):null,t.negotiationType=a||null,t.setAnswerRemoteDesription(i)},n.prototype.handleCallEnd=function(e){var t=e.type,i=e.id,n=e.chatid,a=this.container,o=a.uiHandler,r=a.detailsHandler,s=a.audioImpl,a=a.commonImpl;i==a.getActiveMediaID(n)&&(o.updateCallInvitationState(t,{chid:n,media_id:i},"ended"),o.deleteScreenShareState(n),o.deletePlayer(n),r.clearPlayer()&&a.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_PLAYER_CLEARED,add_info:r.getMediaActivityAddInfo()},mid:i}),r.clearPopup()&&a.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_POPUP_CLEARED,add_info:r.getMediaActivityAddInfo()},mid:i}),s.handleAudioCallEnd(e),this.clearData(e),r.handleCallEnded({type:t,chid:n}))},n.prototype.handleCallOffer=function(e){var t=e.chatid,i=e.id,n=e.session,a=e.tracksId,o=e.negotiationType,r=this.container,s=r.dataHandler,c=r.constants,d=r.MediaPermission,l=r.commonImpl,r=t+"_peer",r=s.get(r)||{};d.getStreamByType(c.screen_share)&&o==c.screen_share&&!this.reinit&&s.set(c.isAlreadySharing,!0),e.isUpStream=!1,e.iceRestart=!1;var p=r[i];r[i]||(r[i]=new f(e,this.container),s.set(t+"_peer",r),p=r[i]),p.remoteTracksId=a?JSON.parse(a):null,p.negotiationType=o||null,l.setRemotePerfectReNegotiation(p,i,t);try{this.reinit?(p.handleScreenShareRenegotiation(n,this.removeTrackOnReNegotiation),this.removeTrackOnReNegotiation=!1):p.setOfferRemoteDescription(n),this.reinit=!1}catch(e){}},n.prototype.handleCallCancel=function(e){var t=e.chatid,i=e.id,n=e.type,a=e.processType,o=this.container,r=o.commonImpl,s=o.uiHandler,c=o.detailsHandler,d=o.constants,o={chid:t,media_id:i};r.deleteScreenShareRequestData(t),r.removeCredential(i),c.isEmbed()&&c.clearConformBox()&&r.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_CONFIRMBOX_CLEARED,add_info:c.getMediaActivityAddInfo()},mid:i}),clearTimeout(this.timeout[i]),a&&a==d.negotiation||(s.updateCallInvitationState("screen_share",o,"cancelled"),r.removeCredential(i),this.clearData(e),i="siqMedia: call cancel request received  | chid :"+t+" | mediaid : "+i+" | curUserId : "+c.getCurrentUserId(),this.callBackAction(this.implConstants.postDebugLog,i),c.handleCallCancelled({type:n,chid:t}))},n.prototype.handleUIReject=function(e,t,i){var n=this.container,a=n.uiHandler,o=n.commonImpl,r=n.detailsHandler,n={};r.isOldUI()&&(n.is_old_ui=r.isOldUI()),a.updateCallInvitationState(e,{chid:t,mid:i},"rejected"),o.makeCallReject(e,i,null,n),this.clearData({type:e,chid:t,mid:i});i=" reject trigger from UI | chid :"+t+" | mediaid : "+i+" | curUserId : "+r.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,i),r.handleCallRejected({type:e,chid:t})},n.prototype.__handleUIAccept=function(i,n,a){var o=this,e=this.container,r=e.commonImpl,s=e.uiHandler,c=e.MediaPermission,d=e.constants,t=e.MediaDetails,l=e.detailsHandler,p=r.getActiveCallData(),u=r.getCallStatusByChid(p),h=r.getCallStatusByChid(n);if(p&&p!=n)for(var m in u){var g=u[m].callStatus,y=u[m].id,_={};l.isOldUI()&&(_.is_old_ui=l.isOldUI()),"connected"==g?this.endOngoingCall(p):"ringing"!=g&&"connecting"!=g||(("upstream"==u[m].host?r.makeCallCancel:r.makeCallReject).bind(r)(i,y,null,_),r.removeActiveCallData())}var f={perfect_renegotiation:t.getClientSupport().perfect_renegotiation};r.getCallStatusByChid(n)[a].mediarequest?c.getScreenShareStream(function(){var e,t=r.getCallStatusByChid(n);t&&t[a]&&r.isScreenRequestPending(n)?(r.deleteScreenShareRequestData(n),r.updateCallStatus(n,a,"connecting"),r.setActiveCallData(n),r.makeCallAccept(i,a,function(){o.handleAcceptSuccessCbk(n,a)},f),e={},l.isOldUI()&&(e.is_old_ui=l.isOldUI()),t={chid:n,media_id:a,muteCbk:function(){return o.toggleMute()},rejectCbk:function(){return"upstream"==h[a].host?r.makeCallCancel(i,a,null,e):r.makeCallReject(i,a,null,e)}},s.updateCallInvitationState(i,t,"connecting"),c.screenEndFromBrowserUI(function(){return o.handleUIEnd({type:i,id:a,chatid:n})}),r.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_SCREEN_PERMISSION_ALLOWED},mid:a})):c.closeStreamByType(d.screen_share)},this.onMediaPermissionFailure(n,a)):r.makeCallAccept("screen_share",id,null,f),r.removeIncomingRequestData({chid:n,id:a}),r.setActiveTab()},n.prototype.handleUIAccept=function(e,t,i,n){var a=this,o=this.container,r=o.uiHandler,s=o.commonImpl,o=o.detailsHandler,s=s.getActiveCallData();s&&s!=t?r.handleCallClash(function(){return a.__handleUIAccept(e,t,i,n)},function(){return a.handleUIReject(e,t,i)}):this.__handleUIAccept(e,t,i,n),o.triggerIconCheck(t)},n.prototype.startScreenShare=function(e){try{var t=this.container,i=t.detailsHandler,n=t.MediaPermission,a=t.commonImpl,o=t.MediaDetails,r=e.mediarequest,s=e.chatid,c=!0,t=r?"view_screen":"share_screen";if(e.perfect_renegotiation=o.getClientSupport().perfect_renegotiation,"visitor"==e.mode){if(i.checkIsSSOnGoing(s,t))return;c=this.isScreenShareAllowed(e,t)}c?r?this.initRequest(this.onMediaPermissionSuccess(e)):n.getScreenShareStream(this.onMediaPermissionSuccess(e),this.onMediaPermissionFailure(s,e.id,!0)):(s="To start Siq Screen Share  - permission checks failed | chid - "+s+" ",this.callBackAction(this.implConstants.postDebugLog,s)),a.setActiveTab()}catch(e){}},n.prototype.initRequest=function(e){e()},n.prototype.onMediaPermissionSuccess=function(e){var t=this,i=this.container,n=i.commonImpl,a=i.ajaxHandler,o=i.MediaPermission;e.mode=e.mode||"visitor";var r=this.constructResponeObj(e),s=n.constructURL(null,null);return n.setActiveCallData(e.chatid),function(){if(!t.checkOngoingCall(e.chatid))return o.closeStreamByType("screen_share"),delete t.iconClicked[chid],function(){};n.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_SCREEN_PERMISSION_ALLOWED}}),a.post(s,r,t.onstarted.bind(t),t.startCallFailure.bind(t))}},n.prototype.onMediaPermissionFailure=function(r,s,c){var d=this;return void 0===c&&(c=!1),function(e,t){try{var i=d.container,n=i.commonImpl,a=i.uiHandler,o=i.detailsHandler,i={};o.isOldUI()&&(i.is_old_ui=o.isOldUI()),c||(n.makeCallReject("screen_share",s,null,i),a.updateCallInvitationState("screen_share",{chid:r,media_id:s},"rejected"),d.clearData({type:"screen_share",chatid:r,id:s}),o.triggerIconCheck(chatid)),n.getActiveCallData()&&n.getActiveCallData()==r&&!n.getCallStatusByChid(r)&&(n.removeActiveCallData(),n.removeActiveTab()),n.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_SCREEN_PERMISSION_BLOCKED}})}catch(e){}}},n.prototype.constructResponeObj=function(e){return Object.assign({},{type:"screen_share"},e)},n.prototype.sendOffer=function(e){this.container.commonImpl.sendOffer(e)},n.prototype.sendAnswer=function(e){this.container.commonImpl.sendAnswer(e)},n.prototype.sendCandidate=function(e){this.container.commonImpl.sendCandidate(e)},n.prototype.onstarted=function(e){var t=this,i=E(E(e.msg||e.data.msg).media),n=this.container,a=n.commonImpl,o=n.uiHandler,r=n.dataHandler,s=n.MediaPermission,c=n.detailsHandler,d=i.chatid,l=i.id,p=i.type,u=i.mediaRequest,e={};e.chid=d,e.id=l,e.type=p,e.callType="outgoing",e.callStatus="ringing",e.mediarequest=u,e.host="upstream",a.sendMediaActivity({param:{action_type:u?v.activity.MEDIA_SCREENSHARE_REQUESTSCREEN:v.activity.MEDIA_SCREENSHARE_SHARESCREEN},mid:l});r.set(l+"_waiting_timer",setTimeout(function(){var e={};c.isOldUI()&&(e.is_old_ui=c.isOldUI()),a.makeCallMissed(p,l,null,e),o.updateCallInvitationState(p,{chid:d,media_id:l},"missed"),t.clearData(i),c.handleCallMissed({type:p,chid:d})},6e4));n=r.get(d+"_call_status",!0)||{};n[l]=e,r.set(d+"_call_status",n,!0);n=function(){return t.handleUICancel(p,d,l)},n={chid:d,media_id:l,rejectCbk:n,cancelCbk:n,muteCbk:function(){},initiated:!0};"screen_share"==e.type?o.makeScreenShareConnecting(p,n):o.showScreenShareMaking(p,n),u||s.screenEndFromBrowserUI(function(){return t.handleUIEnd({type:p,id:l,chatid:d})}),c.triggerIconCheck(d),c.handleCallInitiate({chid:d,type:p})},n.prototype.startCallFailure=function(){},n.prototype.addRemoteStream=function(e,t){var i=this;try{var n=t.type,a=t.mid,o=t.chid,r=t.negotiationType,s=this.container,c=s.constants,d=s.uiHandler,l=s.dataHandler,s=(s.MediaPermission,e.stream);if(e.streams&&(s=e.streams[0]),r==c.audio)return;r=function(){i.handleUIEnd({type:n,id:a,chatid:o})};if(l.get(c.isAlreadySharing)&&(l.set(c.isAlreadySharing,!1),setTimeout(function(){i.handleStopScreenShare({chid:o,id:a})},2e3)),d.states&&d.states[o]&&d.states[o].screen_share&&"sharing"==d.states[o].screen_share.type)return;d.updateCallInvitationState(c.screen_share,{chid:t.chid,id:t.mid,callEndCbk:r},"connected"),d.playScreenShareStream({stream:s,chid:o,mid:a,endCbk:r})}catch(e){}},n.prototype.clearData=function(e){try{var t=this.container,i=t.commonImpl,n=t.dataHandler,a=t.constants,o=e.chatid||e.chid,t=e.id||e.mid;this.closePeerConn(e),i.removeCredential(t),i.checkAVIcon(o),i.clearCallDetails(o,t),i.clearConnectingTimer(t),i.clearMissedCallTimeout(t),n.remove(a.isAlreadySharing),i.getActiveCallData()&&i.getActiveCallData()==o&&!i.getCallStatusByChid(o)&&i.removeActiveCallData(),i.removeIncomingRequestData({chid:o,id:t}),i.stopNotificationSound(),i.checkAndPlayNotification(),i.deleteScreenShareRequestData(o),i.getCallStatusByChid(o)||i.removeActiveTab()}catch(e){}},n.prototype.closePeerConn=function(e){var t=e.chatid,i=e.type,n=e.id;try{var a=this.container.dataHandler.get(t+"_peer");if(!a)return void this.clearMediaPermision(i);var o=a[n];this.container.commonImpl.clearNetworkTimer(o),o.closeConnection(),delete a[n],this.clearMediaPermision(i)}catch(e){}},n.prototype.clearMediaPermision=function(e){this.container.MediaPermission.closeStreamByType(e)},n.prototype.handleUIEnd=function(e){var t=e.type,i=e.id,n=e.chatid,a=this.container,o=a.uiHandler,r=a.detailsHandler,a=a.commonImpl;a.getPeerObject(n,i).curr_connection.audio||o.states[n].audio?this.handleStopScreenShare({chid:n,id:i}):(a.makeCallEnd(t,i),o.updateCallInvitationState(t,{chid:n,media_id:i},"ended"),r.clearPlayer()&&a.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_PLAYER_CLEARED,add_info:r.getMediaActivityAddInfo()},mid:i}),this.clearData(e),r.handleCallEnded({type:t,chid:n}))},n.prototype.callConnected=function(e){this.screenShareConnectedUI(e)},n.prototype.screenShareConnectedUI=function(e){var t=this,i=e.chid,n=e.type,a=e.mid,o=e.isUpStream,r=this.container,s=r.commonImpl,c=r.uiHandler,d=s.getCallStatusByChid(i)[a].mediarequest,r=s.getEligibleMediaAction(e.chid,n),d={chid:i,media_id:a,eligibleOption:r,isViewing:o&&d||!o&&!d,ss_type:c.getCurrentScreenshareType(i),muteCbk:function(){return function(){}},callEndCbk:function(){return t.handleUIEnd({chatid:e.chid,type:n,id:a})}};s.updateCallStatus(i,a,"connected"),c.updateCallInvitationState("screen_share",d,"connected")},n.prototype.callBackAction=function(e,t){({postDebugLog:this.postDebugLog.bind(this)})[e](t)},n.prototype.init=function(){this.implConstants={postDebugLog:"postDebugLog"}},n.prototype.postDebugLog=function(e){this.container.detailsHandler.sendDebugLogger(e,null,null,!0)},n.prototype.handleUICancel=function(e,t,i){var n=this.container,a=n.commonImpl,o=n.uiHandler,r=n.detailsHandler,s=n.constants,n={chid:t,media_id:i,type:e};o.updateCallInvitationState(s.screen_share,n,s.cancelled);s={};r.isOldUI()&&(s.is_old_ui=r.isOldUI()),a.makeCallCancel(e,i,null,s),this.clearData({type:e,chatid:t,id:i}),r.handleCallCancelled({type:e,chid:t})},n.prototype.handleUIRequestCancel=function(e,t,i){var n=this.container,a=n.commonImpl,o=n.uiHandler,r=n.detailsHandler,s=n.constants,n=(n.dataHandler,{chid:t,media_id:i,type:e});a.getSwapRequestCallbackState()?this.handlingRequestStateOnSwap(t,i,"requestCancelled"):o.updateCallInvitationState(s.screen_share,n,s.cancelled);s={process_type:s.negotiation,negotiation_type:e};r.isOldUI()&&(s.is_old_ui=r.isOldUI()),a.makeCallCancel(e,i,null,s),a.clearConnectingTimer(i),a.clearMissedCallTimeout(i),r.handleCallCancelled({type:e,chid:t})},n.prototype.handlingRequestStateOnSwap=function(e,t,i){this.container.uiHandler.states[e];var n={chid:e,type:"screen_share",id:t};this.container.uiHandler.updateCallInvitationState("screen_share",{chid:e,media_id:t,status:i},i),this.setSharingState(n),this.container.commonImpl.deleteSwapRequestCallbackState()},n.prototype.swapScreenShare=function(e){var t=this,i=e.chatid,n=e.id,a=this.container,o=a.audioImpl,r=a.MediaPermission,s=a.constants,e=a.uiHandler,a=a.commonImpl;r.getStreamByType(s.screen_share)?((e=e.states[i])&&e.screen_share&&"sharing"==e.screen_share.type&&(a.setSwapRequestCallbackState(),e.screen_share.type="viewing",e.screen_share.status="requested",e.screen_share.reject_cbk=function(){return t.handleUIRequestCancel(s.screen_share,i,n)}),o.initCallRequest({chid:i,mid:n,negotiationType:s.screen_share})):o.addScreenShareTrack({chid:i,id:n})},n.prototype.getScreenShareType=function(e,t){try{var i=this.container.commonImpl,n=i.getCallStatusByChid(e),a=n&&n[t],i=i.getPeerObject(e,t);if(!n||!a)return-1;if(i&&i.curr_connection&&i.curr_connection.audio)return-1;i=a.mediarequest,a="upstream"==a.host;if(a&&i)return 1;if(a&&!i)return 0;if(!a&&i)return 0;if(!a&&!i)return 1}catch(e){}},n.prototype.endOngoingCall=function(e,t,i){var n=this.container,a=n.dataHandler,o=n.uiHandler,r=n.commonImpl,n=n.audioImpl,s=a.get(e+"_peer"),a={chatid:e,id:t};if(n.handleAudioCallEnd(a),s)for(var c in s){var d=s[c];o.updateCallInvitationState(d.type,{chid:e,media_id:d.mid},"ended"),r.makeCallEnd(d.type,d.mid,i),this.clearData(d),delete s[c]}else r.makeCallEnd("screen_share",t,i),this.clearData(peer);r.stopNotificationSound(),r.removeActiveCallData(e)},n.prototype.isScreenShareSupported=function(){},n.prototype.handleCallRequest=function(e){var t=this,i=e.chatid,n=e.id,a=(e.type,e.processType),o=e.negotiationType,r=this.container,e=r.uiHandler,s=r.constants,c=r.MediaPermission,d=r.commonImpl,r=r.dataHandler;if(a&&a==s.reinit)return c.getStreamByType(s.screen_share)&&r.set(s.isAlreadySharing,!0),void d.getPeerObject(i,n).screenShareRenegotiation();r={chid:i,media_id:n,acceptCbk:function(){t.container.MediaPermission.getScreenShareStream(function(){t.handleUiRequestAccept({chatid:i,id:n,negotiationType:o}),t.setSharingState({chid:i,id:n,type:s.screen_share}),c.screenEndFromBrowserUI(function(){return t.handleUIEnd({type:o,id:n,chatid:i})}),d.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_SCREEN_PERMISSION_ALLOWED},mid:n})},function(){t.handleUiRequestReject({chatid:i,id:n,negotiationType:o}),d.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_SCREEN_PERMISSION_BLOCKED},mid:n})})},rejectCbk:function(){t.handleUiRequestReject({chatid:i,id:n,negotiationType:o})}};e.showScreenShareInvitation(r)},n.prototype.setSharingState=function(e){var t=e.chid,i=e.id,n=e.type,a=this.container,o=a.constants,e=a.uiHandler,r=a.screenShareImpl,e=e.states[t];e.screen_share=e.screen_share||{},e.screen_share.type=o.sharing,e.screen_share.status=o.connected;e.screen_share.reject_cbk=function(){return r.handleUIEnd({chatid:t,type:n,id:i})}},n.prototype.handleUiRequestAccept=function(e){var t=this,i=e.chatid,n=e.id,a=(e.processType,e.negotiationType),o=this.container,e=o.commonImpl,o=o.ajaxHandler,e=e.constructURL("accept",n),a={process_type:"negotiation",negotiation_type:a};o.post(e,a,function(){t.handleUiRequestAcceptSuccessCbk({chatid:i,id:n})},null)},n.prototype.handleUiRequestAcceptSuccessCbk=function(e){var t=e.chatid,e=e.id;this.container.dataHandler.get(t+"_peer")[e].addScreenTrackInConnection()||this.handleInitReNegotiation({chatid:t,id:e,negotiationType:"screen_share"})},n.prototype.handleUiRequestReject=function(e){e.chatid;var t=e.id,i=(e.processType,e.negotiationType),n=this.container,e=n.commonImpl,n=n.ajaxHandler,t=e.constructURL("reject",t),i={process_type:"negotiation",negotiation_type:i};n.post(t,i,null,null)},n.prototype.initCallRequest=function(e){var a=this,o=e.mid,r=(e.negotiationType,e.chatid);this.container.MediaPermission.getAudioStream(function(){var e=a.container,t=e.commonImpl,i=e.ajaxHandler,n=e.dataHandler,e=e.constants;n.get(r+"_peer")[o].audioStream=a.container.MediaPermission.getStreamByType(e.audio);t=t.constructURL("audio",o);i.post(t,{},null,null)},function(){})},n.prototype.handleStopScreenShare=function(e){var t=e.chid,i=e.id,n=this.container,a=n.commonImpl,e=n.uiHandler,n=n.detailsHandler;a.getPeerObject(t,i).removeScreenTrackInConnection()||(this.removeTrackOnReNegotiation=!0,this.handleInitReNegotiation({chatid:t,id:i,negotiationType:"screen_share"})),a.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_RENEGOTIATION_TRACKREMOVED},mid:i}),e.deleteScreenShareState(t),e.deletePlayer(t),n.clearPlayer()&&a.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_PLAYER_CLEARED,add_info:n.getMediaActivityAddInfo()},mid:i})},n.prototype.handleCallMissed=function(e){var t=this.container,i=t.uiHandler,n=t.detailsHandler,a=t.commonImpl,o=e.processType,r=e.chatid,t=i.states[r];t&&t.screen_share&&"viewing"!=t.screen_share.type&&i.deleteScreenShareState(r),n.isEmbed()&&n.clearConformBox()&&a.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_CONFIRMBOX_CLEARED,add_info:n.getMediaActivityAddInfo()}}),a.deleteScreenShareRequestData(r),o&&o==constants.negotiation||(this.clearData(e),n.handleCallMissed({type:e.type,chid:r}))},n.prototype.handleAudioCallEnd=function(e){var t=this.container,i=t.uiHandler,n=t.MediaPermission,a=t.detailsHandler,t=t.commonImpl;n.closeStreamByType("screen_share"),a.isEmbed()&&a.clearConformBox()&&t.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_CONFIRMBOX_CLEARED,add_info:a.getMediaActivityAddInfo()}}),i.deleteScreenShareState(e),i.deletePlayer(e),a.clearPlayer()&&t.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_PLAYER_CLEARED,add_info:a.getMediaActivityAddInfo()}}),a.clearPopup()&&t.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_POPUP_CLEARED,add_info:a.getMediaActivityAddInfo()}})},n.prototype.checkOngoingCall=function(e){for(var t=this.container,i=t.dataHandler,n=t.detailsHandler,a=i.get("media_inv"),o=0;a&&a.length>o;o++)if(a[o][e=n.isembed?n.getChatWinObjById(e,!0).RCHID:e])return!1;return!0},n.prototype.handleInitReNegotiation=function(e){e.chatid;var t=e.id,i=(e.processType,e.negotiationType,this.container),e=i.commonImpl,i=i.ajaxHandler,t=e.constructURL("screenshare",t);this.reinit=!0;i.post(t,{process_type:"reinit"},function(){},null)};var a=function(e){((this.container=e).commonImpl=this).reloadCheck=!1};a.prototype.setCredential=function(e){var t=e.id,i=e.type,i={mid:t,credential:e.credentials,chid:e.chatid,type:i};this.container.dataHandler.set(t+"_credential",i)},a.prototype.removeCredential=function(e){this.container.dataHandler.remove(e+"_credential")},a.prototype.constructURL=function(e,t){var i="media";return e&&(i+="/"+t+"/"+e),i},a.prototype.sendOffer=function(e){e.chid;var t=e.description,i=e.mid,n=(e.type,e.tracksId),a=e.negotiationType,o=e.processType,r=this.container,s=r.detailsHandler,e=r.ajaxHandler,r=this.constructURL("offer",i),i={};i.session=s.toJSON(t),i.tracks_id=s.toJSON(n),i.negotiation_type=a,i.process_type=o,e.post(r,i,null,null)},a.prototype.sendAnswer=function(e){e.chid;var t=e.description,i=e.mid,n=(e.type,e.tracksId),a=e.negotiationType,o=e.processType,r=this.container,s=r.detailsHandler,e=r.ajaxHandler,r=this.constructURL("answer",i),i={};i.tracks_id=s.toJSON(n),i.negotiation_type=a,i.process_type=o,i.session=s.toJSON(t),e.post(r,i,null,null)},a.prototype.sendCandidate=function(e){var t=e.candidates,i=(e.chid,e.mid),e=(e.type,this.constructURL("candidates",i)),i={};i.candidates=t,this.container.ajaxHandler.post(e,i,null,null)},a.prototype.setActiveCallData=function(e){this.container.dataHandler.set("active_call",e,!0)},a.prototype.getActiveCallData=function(){return this.container.dataHandler.get("active_call",!0)},a.prototype.removeActiveCallData=function(){this.container.dataHandler.remove("active_call",!0)},a.prototype.setCallStatus=function(e,t,i,n,a,o,r,s,c){void 0===s&&(s=!1);s={chid:e,id:t,type:i,callType:n,callStatus:a,mediarequest:o,host:r,isdirectcall:s,isPerfectRenegotiation:c},c=this.getCallStatusByChid(e)||{};c[t]=s,this.container.dataHandler.set(e+"_call_status",c,!0)},a.prototype.getCallStatusByChid=function(e){return this.container.dataHandler.get(e+"_call_status",!0)},a.prototype.getAcitveMediaTypes=function(){var e=this.container.dataHandler.get("active_call",!0),e=this.getCallStatusByChid(e);return e?Object.values(e).map(function(e){return e.type}):[]},a.prototype.updateCallStatus=function(e,t,i){var n=this.container.dataHandler,a=n.get(e+"_call_status",!0);a&&a[t]&&(a[t].callStatus=i),n.set(e+"_call_status",a,!0)},a.prototype.checkAVIcon=function(e){var t=this.container,i=t.dataHandler,t=t.uiHandler;i.get("active_call",!0)==e&&t.enableOutingCallUI()},a.prototype.checkNetwork=function(t,i,e){var n=this;void 0===e&&(e=!1);var a=this.container,o=a.dataHandler,a=a.uiHandler,r=o.get(t+"_peer")[i],s=r.type,c="undefined"==typeof _MEDIASERVERURL?_MEDIASTATICURL:_MEDIASERVERURL;r.reconnectInterval=setTimeout(function(){var e=document.createElement("IMG");e.src=c+"/images/spacer.gif?nocache="+(new Date).getTime(),e.onload=function(){r.iceRestart=!0,r.isUpStream&&r.createOffer(),n.updateAcceptedTimeForMediaStats(Date.now(),i)},e.onerror=function(){return n.checkNetwork(t,i,!0)}},5e3),r.reconnectEndTimer||(r.reconnectEndTimer=setTimeout(function(){n.container[s+"Impl"].endOngoingCall(t),clearTimeout(r.reconnectInterval),r.reconnectEndTimer=null},3e4)),e||a.updateCallInvitationState(s,{chid:t,media_id:i},"reconnecting")},a.prototype.clearNetworkTimer=function(e){clearTimeout(e.reconnectEndTimer),clearTimeout(e.reconnectInterval)},a.prototype.clearCallDetails=function(e,t){var i=this.container.dataHandler,n=i.get(e+"_call_status",!0);delete n[t],0<Object.keys(n).length?i.set(e+"_call_status",n,!0):i.remove(e+"_call_status",!0),i.remove(t+"_credential")},a.prototype.updateCommonData=function(){},a.prototype.getCommonData=function(){},a.prototype.makeCallMissed=function(e,t,i,n){this.makeCallHelper("miss",e,t,i,n)},a.prototype.makeCallAccept=function(e,t,i,n){this.makeCallHelper("accept",e,t,i,n)},a.prototype.makeCallCancel=function(e,t,i,n){this.makeCallHelper("cancel",e,t,i,n)},a.prototype.makeCallEnd=function(e,t,i,n){this.makeCallHelper("end",e,t,i,n)},a.prototype.makeCallReject=function(e,t,i,n){this.makeCallHelper("reject",e,t,i,n)},a.prototype.makeCallConnected=function(e){var t=e.callerType,i=e.latency,n=e.lsid,a=e.mediaid,o=e.reconcount,e=e.wmsid,a=this.constructURL("connected",a),n={latency:i,reconcount:o,callerType:t,lsid:n};e&&(n.wmsid=e),this.container.ajaxHandler.post(a,n,null,null)},a.prototype.makeCallHelper=function(e,t,i,n,a){void 0===a&&(a={});var o=Object.assign({},a),r=this.container,a=r.commonImpl,r=r.ajaxHandler,i=a.constructURL(e,i);r.post(i,o,n)},a.prototype.updateIncomingRequestData=function(e){var t={},i=e.chatid,n=e.type,a=e.id,o=e.negotiationType,r=this.container.dataHandler,e=r.get("media_inv")||[];t[i]={type:o||n,id:a},e.push(t),r.set("media_inv",e,!0)},a.prototype.removeIncomingRequestData=function(e){var t,i=e.chid,n=e.id,e=this.container.dataHandler,a=e.get("media_inv",!0);for(t in a){var o=a[t],r=Object.keys(o)[0],o=o[r].id;r==i&&o==n&&a.splice(t,1)}a&&(0==a.length?this.deleteIncomingRequestKey():e.set("media_inv",a,!0))},a.prototype.getIncomingRequest=function(){return this.container.dataHandler.get("media_inv",!0)},a.prototype.deleteIncomingRequestKey=function(){this.container.dataHandler.remove("media_inv",!0)},a.prototype.getMediaDataByChidAndType=function(e){var t,i=e.chatid,n=e.type,a=this.getCallStatusByChid(i);for(t in a){var o=a[t];if(o.type==n)return o}return null},a.prototype.endCallByChid=function(c,d){var l=this;try{var e,p=this.getCallStatusByChid(c),t=this.container,u=t.detailsHandler,h=t.uiHandler,m=t.commonImpl,g=t.dataHandler;for(e in p)!function(e){var t=p[e],i=t.id,n=t.type,a=t.callStatus,o=t.isdirectcall,r=l.container[n+"Impl"],s={chid:c,media_id:i,type:n},e={};u.isOldUI()&&(e.is_old_ui=u.isOldUI()),"connected"==a?(r.endOngoingCall(c,i,d||function(){return o&&u.endSession(c)}),h.updateCallInvitationState(n,s,"ended")):"connected"!=a&&"incoming"==t.callType?(l.clearConnectingTimer(i),o||m.makeCallReject(n,i,d,e),h.updateCallInvitationState(n,s,"rejected"),o&&r.handleUIApiReject(n,c,i)):"connected"!=a&&"outgoing"==t.callType&&(clearTimeout(g.get(i+"_waiting_timer")),m.makeCallCancel(n,i,d,e),h.updateCallInvitationState(n,s,"cancelled")),s.id=i,r.clearData(s)}(e)}catch(e){}},a.prototype.checkOnGoingCall=function(){try{this.checkAndClearDataOnRefresh()}catch(e){}},a.prototype.checkAndClearDataOnRefresh=function(){var t=this;Object.keys(localStorage).forEach(function(e){return e.match(/SiqMedia_/g)&&t.container.dataHandler.remove(e.replace("SiqMedia_",""),!0)})},a.prototype.setActiveTab=function(){this.container.dataHandler.set("media_active",!0)},a.prototype.getActiveTab=function(){return this.container.dataHandler.get("media_active")||!1},a.prototype.removeActiveTab=function(){this.container.dataHandler.remove("media_active")},a.prototype.currentUserBrowserSupportSS=function(){var e=this.container.MediaDetails,t=e.getPlatform();return!!/linux|Microsoft Windows|Mac OS|MacIntel|Win32|Win64/i.test(t)&&e.checkBrowserSupported()},a.prototype.checkIncomingCallAllowed=function(e){var t=e.chatid,i=(e.id,e.type),e=e.negotiationType;if(this.getMediaDataByChidAndType({chatid:t,type:e||i}))for(var n=this.container.dataHandler.get(t+"_peer"),a=n&&Object.keys(n).length||0,o=0;o<a;o++)return"connected"!=n[Object.keys(n)[o]].connectionStatus?(this.endCallByChid(t),!1):!0;return!1},a.prototype.setMediaStatsDetail=function(e){var t=e.acceptedTime,i=e.type,n=e.mediaid,e={acceptedTime:t,type:i,mediaid:n,reconnectCount:e.reconnectCount,lsid:e.lsid,callerType:e.callerType};this.container.dataHandler.set(n+"_connectionstats",e)},a.prototype.updateMediaStatsDetail=function(e){var t=e.connectedTime,i=e.isreconnected,n=e.mediaid,a=this.container.dataHandler,e=a.get(n+"_connectionstats");e.connectedTime=t,e.reconnectCount=i?e.reconnectCount+1:e.reconnectCount,a.set(n+"_connectionstats",e)},a.prototype.updateAcceptedTimeForMediaStats=function(e,t){var i=this.container.dataHandler,n=i.get(t+"_connectionstats");n&&(n.acceptedTime=e,i.set(t+"_connectionstats",n))},a.prototype.getConnectedStatsDetail=function(e){var t=this.container,i=t.dataHandler,t=t.detailsHandler,i=i.get(e+"_connectionstats"),e={latency:i.connectedTime-i.acceptedTime,reconcount:i.reconnectCount,callerType:i.callerType,lsid:i.lsid,mediaid:e};return t.isEmbed()&&(e.wmsid=t.getVisitorWMSID()),e},a.prototype.clearConnectedStatsDetail=function(e){this.container.dataHandler.remove(e+"_connectionstats")},a.prototype.getPeerObject=function(e,t){try{return this.container.dataHandler.get(e+"_peer")[t]||null}catch(e){return null}},a.prototype.handleScreenTrackEnd=function(){var e=this.container,t=e.commonImpl,i=e.detailsHandler,n=e.uiHandler,a=e.MediaPermission,o=e.screenShareImpl,r=e.constants,s=t.getActiveCallData(),c=this.getActiveMediaID(s);n.deleteScreenShareState(s),n.deletePlayer(s),i.clearPlayer()&&t.sendMediaActivity({param:{action_type:r.activity.MEDIA_SCREENSHARE_PLAYER_CLEARED,add_info:i.getMediaActivityAddInfo()},mid:c}),a.getStreamByType("screen_share")&&n.updateCallInvitationState(r.screen_share,{chid:s,id:c,callEndCbk:function(){o.handleUIEnd({type:r.screen_share,id:c,chatid:s})},ss_type:r.sharing},r.connected)},a.prototype.getActiveMediaID=function(e){e=this.getCallStatusByChid(e);return e?Object.keys(e)[0]:""},a.prototype.setScreenShareRequestData=function(e){this.container.dataHandler.set(e+"_screenRequest",!0)},a.prototype.deleteScreenShareRequestData=function(e){this.container.dataHandler.remove(e+"_screenRequest")},a.prototype.isScreenRequestPending=function(e){return!!this.container.dataHandler.get(e+"_screenRequest")},a.prototype.setCallUIPosition=function(e,t){this.container.dataHandler.set("callUIposition",{top:e,left:t})},a.prototype.getCallUIPosition=function(){return this.container.dataHandler.get("callUIposition")},a.prototype.removeCallUIPosition=function(){this.container.dataHandler.remove("callUIposition")},a.prototype.clearMissedCallTimeout=function(e){var t=this.container.dataHandler;clearTimeout(t.get(e+"_waiting_timer")),t.remove(e+"_waiting_timer")},a.prototype.setSwapRequestCallbackState=function(){this.container.dataHandler.set("isScreenShareOngoing",!0)},a.prototype.getSwapRequestCallbackState=function(){return this.container.dataHandler.get("isScreenShareOngoing")},a.prototype.deleteSwapRequestCallbackState=function(){this.container.dataHandler.remove("isScreenShareOngoing")},a.prototype.clearConnectingTimer=function(e){var t=this.container.dataHandler;clearTimeout(t.get(e+"_connecting_timer")),t.remove(e+"_connecting_timer")},a.prototype.setIsCallInitiatedFromOldUI=function(e){this.container.dataHandler.set("isCallInitiatedFromOldUI",e)},a.prototype.getIsCallInitiatedFromOldUI=function(){return this.container.dataHandler.get("isCallInitiatedFromOldUI")},a.prototype.deleteIsCallInitiatedFromOldUI=function(){this.container.dataHandler.remove("isCallInitiatedFromOldUI")},a.prototype.onGoingMediaType=function(e){var t={audio:!1,screenshare:!1},e=this.container.uiHandler.states[e];return e&&e.audio?t.audio=!0:t.audio,e&&e.screen_share?t.screenshare=!0:t.screenshare,t},a.prototype.setRemotePerfectReNegotiation=function(e,t,i){i=this.getCallStatusByChid(i);null!=i[t].isPerfectRenegotiation&&(e.remotePerfectRenegotiation=i[t].isPerfectRenegotiation)},a.prototype.endCallFromSameChat=function(e){var t=e.chid,e=e.id,i=this.getCallStatusByChid(t);if(i&&i[this.getActiveMediaID(t)].id!=e)for(var n in i){var a=i[n],o=a.type+"Impl",r=a.callStatus;"connected"==r?this.container[o].endOngoingCall(t,n):"ringing"!=r&&"connecting"!=r||(("upstream"==i[n].host?this.container[o].handleUICancel:this.container[o].handleUIReject).bind(this.container[o])(a.type,t,a.id),this.removeActiveCallData())}},a.prototype.sendMediaActivity=function(e){var t=e.param,i=e.mid,n=this.container.ajaxHandler,e=this.getActiveCallData(),e=this.getActiveMediaID(e)||i,i="stats/"+e+"/media/activity";e&&n.post(i,t)},a.prototype.checkCallHostType=function(e){var t=e.chid,i=e.mid,e=e.hostType,t=this.getCallStatusByChid(t);return!(!t||!t[i]||t[i].host!=e)},a.prototype.isInvitationPending=function(){var e=this.getIncomingRequest();return!!(e&&0<e.length)};var o=function(e){function t(){e.apply(this,arguments),this.isDirectCallAllowed=!1}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.audioIconStatus=function(e,t,i){void 0===i&&(i=1);var n=this.container,a=n.detailsHandler,o=n.commonImpl,r=n.dataHandler,s=n.MediaDetails,c=o.getMediaDataByChidAndType({chatid:e,type:"audio"})||!1,n=r.get("media_active");-1==e&&t(e,"hide");var d={not_group_chat:!a.isGroupConversation(e),not_bot:!a.isAttenderBot(e),ongoing_chat:a.isChatExist(e),audiocall_enabled:a.isAudioCallEnabled(),current_plan_allowed:a.isPlanAllowed(),is_secure:a.isSecureConnection(),is_proactive_chat:!a.isProactiveChat(e),live_chat_window:a.isliveChatWindow(),isFacebookIntegration:!a.isFaceBookIntegration(),isBrandsDisabled:!r.get("isBrandsDisabled")||!1,isBrowserSupported:s.checkBrowserSupported()},l={ongoing_call_current_chat:c,incoming_call_notification:a.hasIncomingCall(e),ongoing_media:a.onGoingCallForChat(e),isMediaActive:n,isInvitationPending:o.isInvitationPending()},o={1:["not_group_chat","not_bot","ongoing_chat","audiocall_enabled","current_plan_allowed","is_secure","is_proactive_chat","live_chat_window","isFacebookIntegration","isBrandsDisabled","isBrowserSupported"]}[i].map(function(e){return d[e]}).reduce(function(e,t){return e&&t},!0),i={1:["ongoing_call_current_chat","incoming_call_notification","ongoing_media","isMediaActive","isInvitationPending"]}[i].map(function(e){return l[e]}).reduce(function(e,t){return e||t},!1);t(e,o?i?"disable":"show":"hide")},t.prototype.onstarted=function(e){var t=this,i=this.container,n=i.commonImpl,a=i.MediaPermission,o=i.detailsHandler,r=i.uiHandler,s=i.dataHandler,i=i.constants.WAITING_TIME_SECS;if(this.iconClicked={},e.data.error&&"5001"==e.data.error.code)return n.removeActiveTab(),n.removeActiveCallData(),a.closeAllStream(),o.hideAudioCall(),o.clearBusyUI(),o.stopNotifSound(),s.set("isBrandsDisabled",!0),!0;if(e.data.error&&"5004"==e.data.error.code)return this.clearOngoingCallDataOnFailure(),void o.showAudioCall();var e=E(E(e.data.msg).media),c=e.chatid,d=e.id,l=e.type,e=e.mediaRequest;s.set(d+"_waiting_timer",setTimeout(function(){var e={};o.isOldUI()&&(e.is_old_ui=o.isOldUI()),n.makeCallMissed(l,d,null,e),t.clearData({type:l,chatid:c,id:d}),r.updateCallInvitationState(l,{chid:c,media_id:d},"missed")},6e4)),n.setCallStatus(c,d,l,"outgoing","ringing",e,"upstream",!1),n.setActiveCallData(c),o.handleCallInitiate({type:l,chid:c});i={type:"audiocall",duration:i,tone:"outgoingcall",chatid:c,isEncrypted:!1};n.playMediaNotificationSound(i),n.sendMediaActivity({param:{action_type:v.activity.MEDIA_AUDIO_OUTGOING_SOUND_START,add_info:o.getMediaActivityAddInfo()},mid:d});i={chid:c,media_id:d,cancelCbk:function(){t.handleUICancel(l,c,d)},muteCbk:function(){return t.toggleMute()}};r.handleAudioCallInitiate(l,i),o.triggerIconCheck(c)},t.prototype.clearOngoingCallDataOnFailure=function(){var e=this.container,t=e.commonImpl,i=e.MediaPermission,e=e.detailsHandler;t.removeActiveTab(),t.removeActiveCallData(),i.closeAllStream(),e.stopNotifSound()},t.prototype.onstartedSecondary=function(e){var t=this,i=e.chid,n=e.negotiationType,a=e.id,o=this.container,r=o.uiHandler,s=o.detailsHandler,c=o.commonImpl,e=o.constants,o=o.dataHandler,d={process_type:"negotiation",negotiation_type:n};s.isOldUI()&&(d.is_old_ui=s.isOldUI()),this.iconClicked[i]&&delete this.iconClicked[i];e=e.WAITING_TIME;o.set(a+"_waiting_timer",setTimeout(function(){c.makeCallMissed(n,a,null,d),r.updateCallInvitationState("audio",{chid:i,media_id:a},"missed")},e));e={chid:i,media_id:a,cancelCbk:function(){r.updateCallInvitationState("audio",{chid:i,id:a},"cancelled"),c.makeCallCancel(n,a,null,d),c.clearMissedCallTimeout(a)},muteCbk:function(){return t.toggleMute()}};c.sendMediaActivity({param:{action_type:v.activity.MEDIA_AUDIO_RENEGOTIATION_INITIATE},mid:a}),r.handleAudioCallInitiate(n,e),s.handleCallInitiate({type:n,chid:i})},t.prototype.startApiDirectCall=function(e){var t=this,i=(e.conversationType,e.successCbk),n=this.container,a=n.uiHandler,e=n.MediaPermission,n=n.commonImpl,o=function(){clearTimeout(r)},r=setTimeout(function(){o=a.mediaPermissionUI()},3e3);return e.getAudioStream(function(){o(),t.directCallMediaPermissionSuccess(i)},function(){return t.directCallMediaPermissionFailure(function(){return o()})}),n.setActiveTab(),this.isDirectCallAllowed=!0},t.prototype.directCallMediaPermissionSuccess=function(e){var t=this;try{var i=this.container.detailsHandler;i.playNotifSound({tone:"outgoingcall",duration:60}),this.isDirectCallAllowed=!0;e(function(){return t.toggleMute()})}catch(e){}},t.prototype.directCallMediaPermissionFailure=function(e){var t=this.container.uiHandler;return e(),t.mediaPermissionUnlock(),t.directCallCancelled(),!1},t.prototype.handleUIApiReject=function(e,t,i){this.handleUIReject(e,t,i),this.container.detailsHandler.initMissedChat(chatid,"CALLENDED","2",!0)},t.prototype.handleUIApiCallEnd=function(e,t,i){var n=this.container,a=n.commonImpl,o=n.detailsHandler;a.makeCallEnd(t,i,function(){return o.endSession(e)}),this.handleCallEnd({chatid:e,type:t,id:i}),localStorage.removeItem("siq_directcall")},t.prototype.onDirectCallStarted=function(e){var t=this,i=this.container,n=i.commonImpl,a=i.detailsHandler,o=i.uiHandler,r=i.dataHandler,s=e.type,c=e.id,d=e.chatid,i=e.mediaRequest;n.setCredential(e);r.set(c+"_waiting_timer",setTimeout(function(){n.makeCallMissed(s,c),localStorage.removeItem("siq_directcall"),n.clearMissedCallTimeout(c),t.clearData({type:s,chatid:d,id:c}),a.initMissedChat(d,"CALLENDED","2",!0),o.updateCallInvitationState(s,{chid:d,media_id:c},"missed")},6e4)),n.setCallStatus(d,c,s,"outgoing","ringing",i,"upstream",!0),n.setActiveCallData(d);function l(){var e={};a.isOldUI()&&(e.is_old_ui=a.isOldUI()),n.makeCallCancel(s,c,function(){return a.initMissedChat(d,"CALLENDED","2",!0)},e),o.updateCallInvitationState("audio",{chid:d,media_id:c},"cancelled"),localStorage.removeItem("siq_directcall"),n.clearMissedCallTimeout(c),t.clearData({type:s,chatid:d,id:c})}function p(){return t.toggleMute()}a.triggerIconCheck(d);setTimeout(function(){return o.handleAudioCallInitiate(s,{chid:d,cancelCbk:l,muteCbk:p,media_id:c,isDirectCall:!0})},500),clearTimeout(a.getChatWinObjById(d).waitTimer),localStorage.setItem("siq_directcall",R({chid:d,media_id:c,type:s,status:"outgoing"}))},t.prototype.startAudioCallAgain=function(e){var t=this.container,i=t.detailsHandler,t=t.audioImpl;this.hasIncommingCall(e)||(e={type:"audio",chatid:(e=i.getChatWinObjById(e)).chatID,mode:"visitor",mediarequest:!0,mediainvitation:!0,wmsid:$Support.EmbedObj.vwmsid,lsuid:e.attender,lsid:$Support.getParent().$ZSIQWidget.getWidgetObject().lsid},t.startAudioCall(e))},t.prototype.pushVoiceToServer=function(e){var t={},i=$Support.getAjaxURL("makeav",dext),e=this.container.detailsHandler.getChatWinObjById(e);t.action="voicerec",t.wmsid=$Support.EmbedObj.vwmsid,t.chid=e.chatID,t.cuid=e.visitorID,t.lsuid=e.attender,this.container.commonImpl.sendMediaActivity({param:{action_type:v.activity.MEDIA_AUDIO_VOICE}}),$.ajax({url:i,data:t,type:"POST"})},t}(e),r=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.screenshareIconStatus=function(e){var t=e.chid,i=e.callback,n=e.type;void 0===n&&(n=1);var e=this.container.detailsHandler,a={not_group_chat:!e.isGroupConversation(t),not_bot:!e.isAttenderBot(t),ongoing_chat:e.isChatExist(),audiocall_enabled:e.isScreenShareAllowed(t),current_plan_allowed:e.isPlanAllowed()},o={sharescreenAllowed:!e.isShareScreenAllowed(t)},e={1:["not_group_chat","not_bot","ongoing_chat","audiocall_enabled","current_plan_allowed"]}[n].map(function(e){return a[e]}).reduce(function(e,t){return e&&t},!0),n={1:["sharescreenAllowed"]}[n].map(function(e){return o[e]}).reduce(function(e,t){return e&&t},!0);s(i)&&i(t,e?n?"disable":"show":"hide")},t.prototype.isScreenShareAllowed=function(e){var t=e.chatid,i=this.container,n=i.commonImpl,a=i.constants,o=i.detailsHandler,r=i.uiHandler,s=!0,e="",i="";return!n.getMediaDataByChidAndType({chatid:t,type:a.screen_share})&&(o.isSecureConnection()?o.isShareScreenAllowed(t)||(s=!1,i="siqMedia: screen share Failed screen share not allowed | chid - "+t):(s=!1,e=o.I18N("av.info.insecuredwebsite"),i="siqMedia: screen share Failed Visitor not in secure connection | chid - "+t),!s&&e&&(r.showDialog({desc:e,buttons:{accept:{text:"common.ok",callback:function(){return null}}}}),callBackAction(implConstants.postDebugLog,i)),s)},t}(n),c=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),(t.prototype=Object.create(e&&e.prototype)).constructor=t}(i),d=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.checkAndUpdateUIForApi=function(){},t.prototype.playMediaNotificationSound=function(e){this.container.detailsHandler.playNotifSound(e)},t.prototype.stopNotificationSound=function(){this.container.detailsHandler.stopNotifSound()},t.prototype.showDesktopNotif=function(){},t.prototype.startApiCall=function(e){var t=e.conversationtype,t=this.container.constants[t]+"Impl";return this.container[t].startApiDirectCall(e)},t.prototype.getEligibleMediaAction=function(e){var t=this.container,i=t.constants,n=t.detailsHandler,a=t.commonImpl,t=n.isAudioCallEnabled(),o=(n.isScreenShareEnabled(),a.getCallStatusByChid(e)),r=new Array;t&&r.push(i.audio),r.push(i.screen_share),r.push(i.video);for(var s in o)!function(e){var t=o[e];r=r.filter(function(e){return![t.type].includes(e)})}(s);return r},t.prototype.checkAndPlayNotification=function(){},t.prototype.getEligibleMediaAction=function(e){var t=this.container,i=t.constants,n=t.detailsHandler,a=t.commonImpl,t=n.isAudioCallEnabled(),o=(n.isScreenShareEnabled(),a.getCallStatusByChid(e)),r=new Array;t&&r.push(i.audio),r.push(i.screen_share),r.push(i.video);for(var s in o)!function(e){var t=o[e];r=r.filter(function(e){return![t.type].includes(e)})}(s);return r},t.prototype.getFailureMessage=function(e){var t=null;switch(e.name){case"NotFoundError":case"DevicesNotFoundError":t=LSResource.getRealValue("av.info.microphone.notavailable");break;case"SourceUnavailableError":case"PermissionDeniedError":case"SecurityError":case"NotAllowedError":default:t=LSResource.getRealValue("av.info.microphone.blocked")}return t},t.prototype.sendMediaStats=function(e,t){var i=e.msg,n=((i?i.media:null)||e).id,i={};e.statcode&&(i.statcode=e.statcode),i.description=t;n="stats/"+n+"/media";this.container.ajaxHandler.post(n,i,null,null)},t}(a);function y(e,t){for(var i=[],n=arguments.length-2;0<n--;)i[n]=arguments[n+2];return{tag:e,props:t||{},children:i}}function u(e,t){if(void 0===t&&(t={}),-1!=["number","string","undefined"].indexOf(typeof e))return document.createTextNode(e);var i=document.createElement(e.tag);h(i,e.props,t);for(var n=0;n<e.children.length;n++)i.appendChild(u(e.children[n],t));return i}function h(e,t,i){if(!e.skipattr)for(var n in t)"skipattr"==n?e.skipattr=!0:"on"==n.slice(0,2)?function(e,t,i){t=t.slice(2).toLowerCase(),e._listeners&&e._listeners[t]||e.addEventListener(t,function(e){return this._listeners[e.type](e)},!1);(e._listeners||(e._listeners={}))[t]=i}(e,n,t[n]):"ref"===n.slice(0,3)?i.refs[t[n]]=e:"html"===n.slice(0,4)?e.innerHTML=t[n]:"video"!=e.tagName.toLowerCase()||e[n]?n&&void 0!==t[n]&&$(e).attr(n)!=t[n]&&e.setAttribute(n,t[n]):e[n]=t[n]}function l(e,o){var r=0,s=0,c=e,d=!1;function l(e){p(e);var t=getComputedStyle(c),i=parseInt(t.getPropertyValue("left"))||0,n=parseInt(t.getPropertyValue("top"))||0;if(i<0||n<0)return i<0&&(c.style.left="0px"),n<0&&(c.style.top="0px"),d=!1,void(o?window.parent:window).removeEventListener("mousemove",l);var a=parseInt(t.getPropertyValue("right"))||0,t=parseInt(t.getPropertyValue("bottom"))||0;if(a<0||t<0)return a<0&&(c.style.left=i+a+"px"),t<0&&(c.style.top=n+t+"px"),d=!1,void(o?window.parent:window).removeEventListener("mousemove",l);c.style.left=e.pageX-r+"px",c.style.top=e.pageY-s+"px"}function p(e){e.stopPropagation(),e.preventDefault(),e.cancelBubble=!0,e.returnValue=!1}e.addEventListener("mousedown",function(e){p(e),d=!0;var t=getComputedStyle(c),i=parseInt(t.getPropertyValue("left"))||0,t=parseInt(t.getPropertyValue("top"))||0;r=e.pageX-i,s=e.pageY-t,(o?window.parent:window).addEventListener("mousemove",l)}),e.addEventListener("mouseup",function(e){p(e),!0===d&&(d=!1,(o?window.parent:window).removeEventListener("mousemove",l))})}a=function(){this.embed=SiqAVRouter.container.detailsHandler.isEmbed(),this.reRender()};a.prototype.updateState=function(e){e&&(this.state=e);try{this.reRender()}catch(e){}},a.prototype.reRender=function(){var e;this.dom&&1==this.dom.nodeType?this.dom=function e(t,i,n,a){var o,r,s,c=t;if(t)if(o=t,(s=-1!=["string","number"].indexOf(typeof(r=i)))||3==o.nodeType?s&&3==o.nodeType&&o.textContent==r:o.tagName.toLowerCase()==r.tag.toLowerCase()){if("object"==typeof i&&1==t.nodeType){var d=Math.max(t.childNodes.length,i.children.length),l=Array.from(t.childNodes);h(t,i.props||{},a);for(var p=0;p<d;p++)e(l[p],i.children[p]||"",t,a)}}else c=u(i,a),$(t).replaceWith(c);else i&&n.append(u(i,a));return c}(this.dom,this.render(),this.placeholder,this):(e=u(this.render(),this),this.dom&&$(this.dom).replaceWith(e),this.dom=e,this.embed?e&&e.className&&e.className.includes("zsiq_media_videomain")?e&&t(e,this.frameout):this.disableDrag||l(e,this.frameout):this.disableDrag||1!=e.nodeType||$(e).draggable({containment:"window",scroll:!1})),this.dom&&!this.dom.parentNode&&(this.placeholder_prepend?$(this.placeholder).prepend(this.dom):$(this.placeholder).append(this.dom))},a.prototype.destroy=function(){$(this.dom).remove()};var p=function(a){function e(e,t,i,n){void 0===n&&(n=!1),this.state=e,this.placeholder=t,this.refs={},this.container=i,this.constants=i.constants,this.frameout=!0,this.screenShareAllowed=i.detailsHandler.isScreenShareAllowed(),this.isInviteOnly=n,this.isDummyImage=!0,a.call(this)}return a&&(e.__proto__=a),((e.prototype=Object.create(a&&a.prototype)).constructor=e).prototype.destroy=function(){this.ssTimer&&clearInterval(this.ssTimer),this.audioTimer&&clearInterval(this.audioTimer),$(this.dom).remove()},e.prototype.canStartSS=function(){return!this.state.screen_share},e.prototype.__callCbk=function(){m(this.container,this.state.chid,this.embed)},e.prototype.getUI=function(){var e=this.state,t=e.audio,e=e.screen_share;return e&&this.isSharing(e.type)&&!this.isInviteOnly?this.getScreenShareUI():!t||e&&this.isViewing(e.type)&&(!this.isViewing(e.type)||this.isConnected(t.status))?"":this.getAudioCallUI()},e.prototype.getAudioCallBtns=function(){var e=this,t=this.state,i=t.handler,n=(t.name,t.url,t.screen_share),a=t.audio,o=t.chid,r=a.mute,s=a.status,c=(a.media_id,this.container.detailsHandler),d=this.isInvited(s),l=this.isConnected(s),p=this.isRequested(s),u=this.isConnecting(s),h=[this.constants.rejected,this.constants.cancelled,this.constants.missed].includes(s),m=c.isScreenShareAllowed()&&c.isShareScreenAllowed(o),g=n&&this.isConnected(n.status),t=n&&(this.isConnected(n.status)?this.constants.stopsharing:this.constants.cancel),a=l?this.constants.end:this.constants.cancel,c=c.isCallInitiatedFromOldUI();return s!=this.constants.ended?y("div",{class:"siq_media_btns siq_media_flexM"},m&&!n&&l&&!c?y("div",{class:"zsiqmico-screenshare zsiq_media_gbtn",title:S("screenshare"),onclick:function(){return e.container.uiHandler.shareScreen(o)}}):"",n&&this.isSharing(n.type)&&!d&&!this.isInviteOnly?y("div",{class:"zsiqmico-endscreenshare zsiq_media_rbtn",title:S(t),onclick:function(){return i(o,"screen_share","reject")}}):"",l||p||u?y("div",{class:(r?"zsiqmico-unmute":"zsiqmico-mute")+" zsiq_media_wbtn "+(m||g?"zsiq_media_mL13":""),title:S(r?"unmute":"mute"),onClick:function(){return i(o,"audio","mute")}}):"",d?y("div",{class:"zsiqmico-pickcall zsiq_media_gbtn "+(n?"zsiq_media_mL13":""),title:S("accept"),onclick:function(){return i(o,"audio","accept")}}):"",h?"":y("div",{class:"zsiqmico-endcall zsiq_media_rbtn "+(l||p||d||u||g?"zsiq_media_mL13":""),title:S(a),onclick:function(){return i(o,"audio","reject")}})):""},e.prototype.getScreenShareBtns=function(){var e,t,i=this.state,n=i.handler,a=i.screen_share,o=i.audio,r=i.chid,s=SiqAVRouter.container,c=(s.detailsHandler,s.audioImpl,a.status);o&&(e=o.mute,t=o.status);var d=this.isConnected(t),l=this.isConnecting(t),p=this.isEnded(t),u=this.isConnected(c),i=a&&(this.isConnected(a.status)?this.constants.stopsharing:this.constants.cancel),s=o&&(d?this.constants.end:this.constants.cancel),c=this.container.detailsHandler.isAudioCallEnabled();return o&&o.status==this.constants.ended?"":y("div",{class:"siq_media_btns siq_media_flexM"},a&&this.isSharing(a.type)&&!this.isRequested(t)&&!this.isInvited(t)?y("div",{class:"zsiqmico-endscreenshare zsiq_media_rbtn",title:S(i),onclick:function(){return n(r,"screen_share","reject")}}):"",a&&(this.isRequested(t)||this.isInvited(t))?y("div",{title:S(i),class:"zsiqmico-endscreenshare zsiq_media_rbtn zsiq_media_disable"}):"",o&&(d||l)?y("div",{class:(e?"zsiqmico-unmute":"zsiqmico-mute")+" zsiq_media_wbtn "+(d||l?"zsiq_media_mL13":""),title:S(e?"unmute":"mute"),onClick:function(){return n(r,"audio","mute")}}):"",d?y("div",{class:"zsiqmico-endcall zsiq_media_rbtn "+(d||isRequested||isInvited||l||p&&u?"zsiq_media_mL13":""),title:S(s),onclick:function(){return n(r,"audio","reject")}}):"",u&&!o&&c?y("div",{class:"zsiqmico-pickcall zsiq_media_gbtn "+(a?"zsiq_media_mL13":""),title:S("call"),onclick:this.__callCbk.bind(this)}):"")},e.prototype.getAudioCallUI=function(){var e=this.state,t=(e.handler,e.name),i=e.url,n=(e.screen_share,e.audio),a=e.chid,o=(n.mute,n.status),e=this.isInvited(o),o=this.isRequested(o),i=i&&i(n.media_id)?y("img",{src:i(n.media_id,a),alt:t?t(a):"Operator",draggable:"false"}):y("em",{class:"sqico-person"}),n=t(a),n=n&&n[0].toLowerCase();return y("div",{class:"zsiq_media_headshot_main"},y("div",{class:"zsiq_media_headshot"},y("div",{class:"zsiq_media_cirview"},e||o?y("div",{class:"zsiq-media-anim"}):"",y("div",{class:this.isDummyImage?"zsiq_media_userimg":"zsiq_media_imgdummy-"+n},i),y("div",{class:"zsiq_media_detail"},y("div",{class:"zsiq_media_elips zsiq_media_name"},t(a)),y("div",{class:"zsiq_media_info zsiq_media_elips"},b(this.state,this.__getAudioCallStatusPriorityInSS())),y("div",{class:"zsiq_media_dept zsiq_media_flexC",style:"display:none;"},y("span",{class:"zsiqmico-dept"}),y("span",{class:"zsiq_media_elips"})),this.getAudioCallBtns()))))},e.prototype.getScreenShareUI=function(){var e=this.state,t=(e.handler,e.name),i=e.url,n=e.screen_share,a=(e.audio,e.chid),e=(n.status,t(a)),e=e&&e[0].toLowerCase(),n=i&&i(n.media_id)?y("img",{src:i(n.media_id,a),alt:t?t(a):"Operator",draggable:"false"}):y("em",{class:"sqico-person"});return y("div",{class:"zsiq_media_headshot_main"},y("div",{class:"zsiq_media_headshot"},y("div",{class:"zsiq_media_cirview"},y("div",{class:this.isDummyImage?"zsiq_media_userimg":"zsiq_media_imgdummy-"+e},n),y("div",{class:"zsiq_media_detail"},y("div",{class:"zsiq_media_elips zsiq_media_name"},t(a)),y("div",{class:"zsiq_media_info zsiq_media_elips"},w(this.state,!1)),y("div",{class:"zsiq_media_dept zsiq_media_flexC",style:"display:none;"},y("span",{class:"zsiqmico-dept"}),y("span",{class:"zsiq_media_elips"})),this.getScreenShareBtns()))))},e.prototype.inviteCheck=function(){var e=this.state,t=e.screen_share,e=e.audio;return!this.isInviteOnly||t&&e&&this.isSharing(t.type)&&!this.isConnected(e.status)&&!this.isEnded(e.status)},e.prototype.render=function(){return!this.inviteCheck()||this.state.isDirectCall||document.querySelector("#call_Busy")?"":this.getUI()},e.prototype.__getAudioCallStatusPriorityInSS=function(){var e=this.state,t=e.screen_share,i=e.audio,e=e.timer,i=i.status;return!(e&&!t&&this.__isStatusNotConnected(i))&&!!(e&&!t||e&&!this.__isStatusNotConnected(i))},e.prototype.__isStatusNotConnected=function(e){return e!=this.constants.connected},e.prototype.isConnected=function(e){return e&&e==this.constants.connected},e.prototype.isConnecting=function(e){return e&&e==this.constants.connecting},e.prototype.isEnded=function(e){return e&&e==this.constants.ended},e.prototype.isInvited=function(e){return e&&e==this.constants.invited},e.prototype.isRequested=function(e){return e&&e==this.constants.requested},e.prototype.isSharing=function(e){return e&&e==this.constants.sharing},e.prototype.isViewing=function(e){return e&&e==this.constants.viewing},e.prototype.isReconnecting=function(e){return e&&e==this.constants.reconnecting},e.prototype.isRejected=function(e){return e&&e==this.constants.rejected},e.prototype.isMissed=function(e){return e&&e==this.constants.missed},e}(a);function m(e,t,i){void 0===i&&(i=!0);var n={type:e.constants.audio,mode:e.constants.visitor,mediarequest:!0,mediainvitation:!0},a=e.detailsHandler.getChatWinObjById(t);i?$.extend(n,{chatid:a.chatID,wmsid:$Support.EmbedObj.vwmsid,lsuid:a.attender,lsid:$Support.getParent().$ZSIQWidget.getWidgetObject().lsid,normalchid:t}):$.extend(n,{chatid:t}),e.audioImpl.startAudioCall(n)}var g=function(n){function e(e,t,i){this.state=e,this.placeholder=t,this.refs={},this.container=i,this.constants=i.constants,this.showSSList=!1,this.showMoreOptions=!1,this.showSettings=!1,this.placeholder_prepend=!0,this.init(),n.call(this)}return n&&(e.__proto__=n),((e.prototype=Object.create(n&&n.prototype)).constructor=e).prototype.init=function(){this.fullscreen=!1,this.showcntrl=!1,this.frameout=!0,this.switchCbk=this.switchFullscreen.bind(this)},e.prototype.switchFullscreen=function(){this.fullscreen=!this.fullscreen,this.fullscreen?window.addEventListener(this.constants.keyup,this.switchCbk):window.removeEventListener(this.constants.keyup,this.switchCbk),this.reRender()},e.prototype.getAudioCallBox=function(){var e=this.state,t=e.audio,i=e.handler,n=e.chid,a=e.name,o=e.url,r=this.embed?"siqico":"sqico",e=t&&(this.isConnected(t.status)?this.constants.end:this.constants.cancel);return y("div",{class:"zsiq_calldtl"},y("span",null,o&&o(t.media_id)?y("img",{src:o(t.media_id,n),alt:a?a(n):"Operator",class:"siquserimg"}):y("em",{class:r+"-user"}),y("em",{class:"zsiq_caller txtelips"},a(n))),y("span",null,b(this.state),t&&this.isConnected(t.status)?y("em",{title:S(t.mute?"unmute":"mute"),class:r+"-"+(t.mute?"unmute":"mute")+" zsiq_ctrlico",onClick:function(){return i(n,"audio","mute")},"data-type":"mic"}):"",t&&this.isInvited(t.status)?y("em",{title:S("accept"),class:r+"-end zsiq_vend zsiq_ctrlico zsiq_callin",onclick:function(){return i(n,"audio","accept")}}):"",y("em",{title:S(e),class:r+"-end zsiq_vend zsiq_ctrlico",onclick:function(){return i(n,"audio","reject")}}),y("em",null)))},e.prototype.showCntrl=function(){var e=this;this.showcntrl=!0,clearTimeout(this.showCntrlTimer),this.showCntrlTimer=setTimeout(function(){e.showcntrl=!1,e.reRender()},1500),this.__swapHandlerClickCbk(),this.reRender()},e.prototype.__swapHandlerClickCbk=function(){this.swapOptions&&($(this.swapOptions).remove(),this.swapOptions=null)},e.prototype.__swapHandler=function(e,n,t){function a(){return o.__swapHandlerClickCbk.call(o)}function i(e,t,i){n(e,t,i),a()}var o=this;if(this.swapOptions)return a();this.swapOptions=u(y("div",{class:"zsiqcalloptions",id:"calloptions",style:"left:"+(e.clientX-220)+";top:"+(e.clientY-65)+";height:65px;z-index:11111111111;",onMouseLeave:this.__swapHandlerClickCbk.bind(this)},y("div",{onClick:function(){return i(t,"screen_share","swap")}},LSResource.getRealValue("screenshare.sharemyscreen")),y("div",{onClick:function(){return i(t,"screen_share","reject")}},LSResource.getRealValue("screenshare.endscreen")))),this.placeholder.append(this.swapOptions)},e.prototype._SwapList=function(e,t,i){this.embed&&this.state.audio&&!this.fullscreen?this.__swapHandler(e,t,i):t(i,"screen_share","swap")},e.prototype.__showMoreOptions=function(){var e,t=this;this.showMoreOptions||(e=function(){t.showMoreOptions=!1,t.updateState(),parent.document.removeEventListener(t.constants.click,e)},this.showMoreOptions=!0,setTimeout(function(){return parent.document.addEventListener(t.constants.click,e)}),this.updateState())},e.prototype.__showSettings=function(){var e,t=this;this.showSettings||(e=function(){t.showSettings=!1,t.updateState(),parent.document.removeEventListener(t.constants.click,e)},this.showSettings=!0,setTimeout(function(){return parent.document.addEventListener(t.constants.click,e)}),this.updateState())},e.prototype.__showDropDownList=function(){var e,t=this;this.showSSList||(e=function(){t.showSSList=!1,t.updateState(),parent.document.removeEventListener(t.constants.click,e)},this.showSSList=!0,setTimeout(function(){return parent.document.addEventListener(t.constants.click,e)}),this.updateState())},e.prototype.__callCbk=function(){m(this.container,this.state.chid,this.embed)},e.prototype.getScreenShareButtons=function(){var e,t,i=this.state,n=i.screen_share,a=i.audio,o=i.handler,r=i.chid,s=i.chatWinFocused;a&&(e=a.mute,t=a.status);var c=this.isConnected(t),d=n.status,l=(n.type,this.isConnected(d)),i=(n&&(l?this.constants.stopsharing:this.constants.cancel),a&&(c?this.constants.end:this.constants.cancel)),d=this.container.detailsHandler.isAudioCallEnabled(),n=a&&[this.constants.invited,this.constants.requested,this.constants.connecting,this.constants.cancelled,this.constants.rejected,this.constants.missed].includes(t);return y("div",{class:"zsiq_media_videofoot"},y("div",{class:"zsiq_media_posrel"},l&&!n?y("div",{class:"zsiqmico-more zsiq_media_wbtn",title:S("options"),onMouseUp:this.__showDropDownList.bind(this)}):"",y("div",{class:"zsiq_media_options",style:this.showSSList?"display:block;":"display:none;"},y("div",{class:"zsiq_media_option_li",onclick:function(){return o(r,"screen_share","swap")}},LSResource.getRealValue("screenshare.sharemyscreen")))),l&&n?y("div",{class:"zsiqmico-more zsiq_media_wbtn zsiq_media_disable"}):"",y("span",{class:"zsiqmico-chat zsiq_media_wbtn",style:"display:none;"}),this.embed&&a&&(c||this.isConnecting(t)||this.isRequested(t))&&!n?y("div",{class:(e?"zsiqmico-unmute":"zsiqmico-mute")+" zsiq_media_wbtn zsiq_media_mL13",title:S(e?"unmute":"mute"),onClick:function(){return o(r,"audio","mute")}}):"",(this.embed||this.fullscreen||!s)&&!a&&l&&d?y("span",{title:S("call"),class:"zsiqmico-pickcall zsiq_media_gbtn zsiq_media_mL13",onclick:this.__callCbk.bind(this)}):"",this.embed&&a&&n?y("span",{class:"zsiqmico-pickcall zsiq_media_gbtn zsiq_media_mL13 zsiq_media_disable"}):"",this.embed&&a&&c?y("span",{title:S(i),class:"zsiqmico-endcall zsiq_media_rbtn zsiq_media_mL13",onclick:function(){return o(r,"audio","reject")}}):"")},e.prototype.getUI=function(){var e=this,t=this.state,i=t.screen_share,n=(t.audio,t.timer),t=i?i.stream:"";return t?y("div",{class:"zsiq_media_videomain "+(this.fullscreen?"zsiq-media-maxscreen":"zsiq-media-minscreen")+" "+(this.showcntrl||!n?"zsiq_showcntl":"")+" ",onMouseMove:this.showCntrl.bind(this),onMouseOver:this.showCntrl.bind(this),onMouseDown:this.__swapHandlerClickCbk.bind(this)},y("div",{class:"zsiq_media_videohdr"},y("div",{class:"zsiq_media_videotime"},w(this.state)),y("div",{class:"zsiq_media_videohdrico"},y("span",{class:"zsiqmico-settings",style:"display:none;"}),y("span",{class:this.fullscreen?"zsiqmico-minscreen":"zsiqmico-maxscreen",onclick:this.switchFullscreen.bind(this)}))),this.getScreenShareButtons(),y("div",null,y("video",{autoplay:!0,name:"media",srcObject:t,class:this.isReconnecting(i.status)?"zsiq_media_blur":"",onloadedmetadata:function(){return e.metadata=!0}})),"reconnecting"!=i.status&&this.metadata?"":y("div",{class:"zsiq_media_vloader"}),this.fullscreen?"":y("div",{enable_resize:!0,class:"zsiq_drag-handle zsiq_top_left_corner",position:"top_left_corner"}),this.fullscreen?"":y("div",{enable_resize:!0,class:"zsiq_drag-handle zsiq_top_border",position:"top_border"}),this.fullscreen?"":y("div",{enable_resize:!0,class:"zsiq_drag-handle zsiq_top_right_corner",position:"top_right_corner"}),this.fullscreen?"":y("div",{enable_resize:!0,class:"zsiq_drag-handle zsiq_right_border",position:"right_border"}),this.fullscreen?"":y("div",{enable_resize:!0,class:"zsiq_drag-handle zsiq_bottom_right_corner",position:"bottom_right_corner"}),this.fullscreen?"":y("div",{enable_resize:!0,class:"zsiq_drag-handle zsiq_bottom_border",position:"bottom_border"}),this.fullscreen?"":y("div",{enable_resize:!0,class:"zsiq_drag-handle zsiq_bottom_left_corner",position:"bottom_left_corner"}),this.fullscreen?"":y("div",{enable_resize:!0,class:"zsiq_drag-handle zsiq_left_border",position:"left_border"})):""},e.prototype.render=function(){var e=this.state,t=e.screen_share,e=e.audio;return t&&this.isViewing(t.type)&&!this.isRequested(t.status)||e&&this.isConnected(e.status)?this.getUI():""},e.prototype.isConnected=function(e){return e&&e==this.constants.connected},e.prototype.isConnecting=function(e){return e&&e==this.constants.connecting},e.prototype.isEnded=function(e){return e&&e==this.constants.ended},e.prototype.isInvited=function(e){return e&&e==this.constants.invited},e.prototype.isRequested=function(e){return e&&e==this.constants.requested},e.prototype.isSharing=function(e){return e&&e==this.constants.sharing},e.prototype.isViewing=function(e){return e&&e==this.constants.viewing},e.prototype.isReconnecting=function(e){return e&&e==this.constants.reconnecting},e.prototype.isRejected=function(e){return e&&e==this.constants.rejected},e.prototype.isMissed=function(e){return e&&e==this.constants.missed},e}(a);function _(){var e=getBrowserFromUserAgent(navigator.userAgent).split("-")[0],t={Chrome:"https://support.google.com/chrome/answer/2693767?hl=en",Firefox:"https://support.mozilla.org/en-US/questions/1168156",Opera:"https://help.opera.com/en/latest/web-preferences/#microphone",Safari:"https://support.apple.com/en-in/guide/safari/websites-ibrwe2159f50/mac"};t[e]&&window.open(t[e],"_blank")}function C(i,n,a,o,r,s){function c(){$(t).remove()}function e(){var e=$(parent.document.body).find(".siq_media"),t=Recorder();i.uiHandler.setCallUIposition("#user_busy"),r||(c(),e.append($Temp.getAudioRecordedUI(a(0,n),o(n),s().top,s().left)),i.commonImpl.removeCallUIPosition()),t.init(r,n)}var t,d=o(n);d&&d[0].toLowerCase();t=r?u(y("div",{class:"cal-wrap",id:"audiorec"},y("div",{class:"posrel dib-mid"},y("div",{class:"cal-widgt theme1 outcal"},y("div",{class:"posrel usr-imginfo"},y("div",{class:"cal-visimg "+((d=$Support.EmbedObj.clogo)?"":"sqico-user")},d?y("img",{src:d,alt:o?o(n):"Operator",draggable:"false"}):"")),y("div",{class:"cal-vstrdetl"},y("nav",{class:"cal-actvevstr elips font18"},LSResource.getRealValue("av.info.oprbusy")),y("p",{class:"cal-usrdesc elips"},LSResource.getRealValue("av.info.voicemsg"))),y("div",{class:"cal-optns posrel textR"},y("span",{onclick:e,class:"sqico-record bg-aaa"})))))):u(y("div",{class:"zsiq_media_headshot_main",id:"user_busy",style:"top:"+s().top+"px; left:"+s().left+"px;"},y("div",{class:"zsiq_media_headshot"},y("div",{class:"zsiq_media_cirview"},y("span",{class:"zsiqmico-close",onclick:c,onMouseUp:function(){i.commonImpl.removeCallUIPosition()}}),y("div",{class:"zsiq_media_userimg"},y("img",{src:a&&a(0,n),alt:o?o(n):"Operator",draggable:"false"})),y("div",{class:"zsiq_media_detail"},y("div",{class:"zsiq_media_elips zsiq_media_name"},o(n)),y("div",{class:"zsiq_media_elips"},LSResource.getRealValue("av.info.userbusy")),y("div",{class:"siq_media_btns siq_media_flexM"},y("div",{class:"zsiqmico-record zsiq_media_wbtn",title:LSResource.getRealValue("av.info.voicemessage"),onclick:e}),y("div",{class:"zsiqmico-pickcall zsiq_media_gbtn zsiq_media_mL13",title:LSResource.getRealValue("av.info.callagain"),onclick:function(){c(),m(i,n)}}))))))),r?(CallImpl.isCallWithChat=!0,$("body").prepend(t)):(l(t,!0),$(parent.document.body).find(".siq_media").append(t))}var I=function(n){function e(e,t,i){this.state=e,this.placeholder=t,this.refs={},this.container=i,this.disableDrag=!0,this.placeholder_prepend=!0,n.call(this)}return n&&(e.__proto__=n),((e.prototype=Object.create(n&&n.prototype)).constructor=e).prototype.getAudioCallStatusText=function(){var e=this.state.audio.status,t=this.state.timer;return{timer:t,connected:LSResource.getRealValue("common.connected"),invited:LSResource.getRealValue("av.info.calling"),connecting:LSResource.getRealValue("av.info.connecting"),ended:LSResource.getRealValue("common.ended"),cancelled:LSResource.getRealValue("av.info.cancelled"),rejected:LSResource.getRealValue("common.declined"),requested:LSResource.getRealValue("audiovideo.ringing"),missed:LSResource.getRealValue("common.missed"),reconnecting:LSResource.getRealValue("common.reconnecting"),initiated:LSResource.getRealValue("audiovideo.ringing"),mediapermission:LSResource.getRealValue("av.info.waitingformediapermission")}[t?"timer":e]||""},e.prototype.getUI=function(){var e=this.state,t=e.url,i=e.handler,n=e.name,a=e.chid,o=e.audio,e=o&&o.status,t=-1==["initiated","requested"].indexOf(e)&&t&&t(o.media_id,a)||$Support.EmbedObj.clogo,r="initiated"==e,s="mediapermission"==e;return y("div",{class:"cal-wrap",id:"audiocal"},y("div",{class:"posrel dib-mid"},y("div",{class:"cal-widgt theme1 outcal"},y("div",{class:"posrel usr-imginfo"},y("div",{class:"cal-visimg "},y("img",{src:t,alt:n?n(a):"Operator"}))),y("div",{class:"cal-vstrdetl"},y("nav",{class:"cal-actvevstr elips font18"},n&&n(a)||""),y("p",{class:"cal-usrdesc elips"},this.getAudioCallStatusText())),y("div",{class:"cal-optns posrel textR"},y("span",{title:o&&S(o.mute?"unmute":"mute"),id:"audiocall_mute",class:"sqico-"+(o.mute?"muteaudio":"microphone")+" bg-aaa "+(s?"cmn_disable":""),onclick:function(){return s?"":i(a,"audio","mute")}}),y("span",{class:"sqico-call cal-rjct "+(r||s?"cmn_disable":""),id:"audiocall_outgoingend",onclick:function(){return r||s?"":i(a,"audio","reject")}})))))},e.prototype.render=function(){var e=this.state,t=e.isDirectCall,i=e.audio;e.status;return t&&i?this.getUI():""},e}(a);function S(e){var t={mute:LSResource.getRealValue("av.info.mute"),unmute:LSResource.getRealValue("av.info.unmute"),end:LSResource.getRealValue("common.end"),reject:LSResource.getRealValue("common.reject"),screenshare:LSResource.getRealValue("common.screenshare"),swap:LSResource.getRealValue("av.info.swap"),call:LSResource.getRealValue("av.info.call"),cancel:LSResource.getRealValue("common.cancel"),accept:LSResource.getRealValue("common.accept"),stopsharing:LSResource.getRealValue("av.info.endscreen"),options:LSResource.getRealValue("av.info.options")};return t[e]||""}function A(e,t){return"theme4"!=D()?"":y("div",{class:"thme-bgimg",style:"background-image:url("+("Comp"==e?$Support.EmbedObj.clogo:_SCHEMA+"://"+_EMBEDSERVERURL+"/"+_SCREENNAME+"/userimg/"+t.attenderimagefkey+"/photo.ls?nps=404")+")"})}function D(){return window.parent.$ZSIQWidget.getWidgetObject().calltheme||"theme1"}function b(e,t){void 0===t&&(t=!0);var i=e.audio.status,e=e.timer;return t="reconnecting"!=i&&t,{timer:e,connected:LSResource.getRealValue("common.connected"),invited:LSResource.getRealValue("av.info.calling"),connecting:LSResource.getRealValue("av.info.connecting"),ended:LSResource.getRealValue("common.ended"),cancelled:LSResource.getRealValue("av.info.cancelled"),rejected:LSResource.getRealValue("common.declined"),requested:LSResource.getRealValue("audiovideo.ringing"),missed:LSResource.getRealValue("common.missed"),reconnecting:LSResource.getRealValue("common.reconnecting")}[e&&t?"timer":i]||""}function w(e,t){void 0===t&&(t=!0);var i=e.screen_share.status,e=e.timer;return t="reconnecting"!=i&&t,{timer:e,connected:LSResource.getRealValue(t?"common.connected":"ss.info.viewing"),invited:LSResource.getRealValue("av.info.calling"),connecting:LSResource.getRealValue("av.info.connecting"),ended:LSResource.getRealValue("common.ended"),cancelled:LSResource.getRealValue("av.info.cancelled"),rejected:LSResource.getRealValue("common.declined"),requested:LSResource.getRealValue("audiovideo.ringing"),missed:LSResource.getRealValue("common.missed"),reconnecting:LSResource.getRealValue("common.reconnecting")}[e&&t?"timer":i]||""}function T(e){return SiqAVRouter.container.detailsHandler.getChatWinObjById(e)}function k(e,t){return void 0===e&&(e=0),t=T(t).attenderimagefkey,e=_SCHEMA+"://"+_EMBEDSERVERURL+"/"+_SCREENNAME+"/userimg/"+t+"/photo.ls?mid="+e,t?e:$Support.EmbedObj.clogo}function M(e){return SiqAVRouter.container.detailsHandler.getDecodedText(U[e])||""}function O(){return SiqAVRouter.container.commonImpl.getCallUIPosition()}function H(e){var t=this;this.container=e,this.invitations=null,this.ss_invitation={},this.states={},window.onbeforeunload=function(){var e=localStorage.getItem("siq_directcall");if((e=e&&JSON.parse(e))&&(e.is_refreshed=!0,localStorage.setItem("siq_directcall",JSON.stringify(e))),Object.keys(t.states).length)return""},this.siqdom=document.createElement("div"),this.siqdom.setAttribute("class","siq_media"),this.container.detailsHandler.getBody()[0].append(this.siqdom)}var U={};function q(){return SiqAVRouter.container.detailsHandler.isEmbed()?$(parent.document.body):$("body")}H.prototype.initiateHeadshot=function(e,t){this.states[e]||(this.states[e]={chid:e,isDirectCall:t},this.states[e].headshot=new p(this.states[e],t?$("body"):this.siqdom,this.container),this.states[e].headshotInvite=new p(this.states[e],t?$("body"):this.siqdom,this.container,!0),this.states[e].directCallUI=new I(this.states[e],$("body"),this.container))},H.prototype.updateCallInvitationState=function(e,t,i){e="screen_view"==e?"screen_share":e;var n={audio:{connecting:this.makeAudioCallConnecting,connected:this.makeAudioCallConnected,ended:this.makeAudioCallEnded,cancelled:this.makeAudioCallCancelled,rejected:this.makeAudioCallRejected,missed:this.makeAudioCallMissed,reconnecting:this.makeAudioReconnecting},screen_share:{connecting:this.makeScreenShareConnecting,connected:this.makeScreenShareConnected,ended:this.makeScreenShareEnded,cancelled:this.makeScreenShareCancelled,rejected:this.makeScreenShareRejected,missed:this.makeScreenShareMissed,reconnecting:this.makeScreenShareReconnecting}},a=n[e]&&n[e][i];try{a&&a.call(this,e,t)}catch(e){}},H.prototype.playScreenShareStream=function(e){var t=e.stream,i=e.mid,e=(e.endCbk,e.chid);this.initiateHeadshot(e);var n=this.states[e];n.screen_share=n.screen_share||{},$.extend(!0,n,{screen_share:{stream:t,type:"viewing",status:"connected"}});try{n.player||(n.player=new g(n,this.siqdom,this.container),this.container.commonImpl.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_PLAYER_SHOWN,add_info:this.container.detailsHandler.getMediaActivityAddInfo()},mid:i}))}catch(e){}},H.prototype.handleAudioCallInvite=function(e,t){U[t.chid]=T(t.chid).attendername,"audio"==e?(this.showAudioCallInvitation(t),this.invitations=!0,this.container.commonImpl.sendMediaActivity({param:{action_type:v.activity.MEDIA_AUDIO_INVITATION_SHOWN,add_info:this.container.detailsHandler.getMediaActivityAddInfo()},mid:t.media_id||t.id})):"screen_share"==e&&this.showScreenShareInvitation(t);t=parent.document.querySelector(".zsiqmico-close");t&&t.click()},H.prototype.clearAudioCallInvite=function(e,t,i){try{this.container.detailsHandler.isEmbed()&&this.container.detailsHandler.clearConformBox()&&this.container.commonImpl.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_CONFIRMBOX_CLEARED,add_info:this.container.detailsHandler.getMediaActivityAddInfo()},mid:t}),"audio"==e&&i&&this.__callTerminate(e,{chid:i,media_id:t,isDirectCall:!1},"rejected")}catch(e){}},H.prototype.showAudioCallInvitation=function(e){var t=e.chid,i=e.rejectCbk,n=e.acceptCbk,a=e.media_id;this.initiateHeadshot(t);e=this.states[t];$.extend(!0,e,{handler:this.handleActionHandler.bind(this),name:M,url:k,chid:t,audio:{mute:!1,media_id:a,reject_cbk:i,accept_cbk:n,is_invited:!0,status:"invited"}}),this.__updateState(t)},H.prototype.handleAudioCallInitiate=function(e,t){var i=this,n=t.chid,a=t.cancelCbk,o=t.muteCbk,r=t.media_id,s=t.isDirectCall,c=this.container,d=c.commonImpl,t=c.detailsHandler;s?(this.states[n]=this.states.directcall,delete this.states.directcall):this.initiateHeadshot(n,s),U[n]=T(n).attendername;var l=this.states[n],c=parent.document.querySelector(".zsiqmico-close");c&&c.click(),$.extend(!0,l,{handler:this.handleActionHandler.bind(this),name:M,url:k,chid:n,audio:{mute:!!s&&l.audio.mute,media_id:r,reject_cbk:a,mute_cbk:function(){o(),$.extend(!0,l,{audio:{mute:!i.states[n].audio.mute}}),i.__updateState(n)},is_invited:!1,status:"requested"}}),this.__updateState(n),d.sendMediaActivity({param:{action_type:v.activity.MEDIA_AUDIO_UI_SHOWN,add_info:t.getMediaActivityAddInfo()},mid:r})},H.prototype.initiateDirectCallUI=function(e){var t=this;void 0===e&&(e=null);function i(){e(),$.extend(!0,o,{audio:{mute:!t.states[n].audio.mute}}),t.__updateState(n)}var n="directcall";if(e){var a=this.states[n];return $.extend(!0,a,{audio:{mute:!1,mute_cbk:i,status:"initiated"}}),void this.__updateState(n)}$("#audiorec,#audiocal").remove(),this.initiateHeadshot(n,!0);var o=this.states[n];$.extend(!0,o,{audio:{mute:!1,mute_cbk:i,status:"mediapermission"}}),this.__updateState(n)},H.prototype.makeAudioCallConnecting=function(e,t){var i=this,n=t.chid,a=t.muteCbk,o=t.rejectCbk,r=t.media_id,s=(t.name,t.isDirectCall),c=this.container,d=c.commonImpl,c=c.detailsHandler,l=this.states[n];EmbedSound.stop(),U[t.chid]=T(t.chid).attendername,$.extend(!0,l,{isDirectCall:s,audio:{mute_cbk:function(){a(),$.extend(!0,l,{audio:{mute:!i.states[n].audio.mute}}),i.__updateState(n)},reject_cbk:o,status:"connecting"}}),this.__updateState(n),d.checkCallHostType({chid:n,mid:r,hostType:"downstream"})&&d.sendMediaActivity({param:{action_type:v.activity.MEDIA_AUDIO_UI_SHOWN,add_info:c.getMediaActivityAddInfo()},mid:r}),s&&this.stopSoundNotification()},H.prototype.makeAudioCallConnected=function(e,t){t.media_id;var i=t.chid,n=t.callEndCbk,a=t.isDirectCall,o=this.container.constants.connected;EmbedSound.stop(),this.initiateHeadshot(i),this.ss_invitation[i]&&delete this.ss_invitation[i];var r=this.states[i],t=r.audio.status==o?r.audio.connected_time:(new Date).getTime();$.extend(!0,r,{isDirectCall:a,audio:{reject_cbk:n,status:o,connected_time:t}}),setTimeout(this.startTimer.bind(this,i,e),500),this.__updateState(i)},H.prototype.makeAudioReconnecting=function(e,t){this.__makeReconnecting(e,t)},H.prototype.makeAudioCallEnded=function(e,t){this.__callTerminate(e,t,"ended")},H.prototype.makeAudioCallCancelled=function(e,t){this.__callTerminate(e,t,"cancelled")},H.prototype.makeAudioCallRejected=function(e,t){this.states[t.chid].isDirectCall&&this.container.detailsHandler.initMissedChat(t.chid,"CALLENDED","2",!0),this.__callTerminate(e,t,"rejected")},H.prototype.makeAudioCallMissed=function(e,t){this.__callTerminate(e,t,"missed")},H.prototype.__recordSound=function(e,t,i,n){var a=this,o=this.container.detailsHandler.isChatExist(e),r=this.container.detailsHandler.getAttenderId(e);(this.container.detailsHandler.getSupportRepCount(e)<2&&o&&("rejected"==n&&r==i||"missed"==n)||t)&&(C(this.container,e,k,M,t,O),this.__updateState(e),$(".zsiq_media_headshot_main .zsiqmico-close").on("click",function(){return a.__updateState(e)}))},H.prototype.__callTerminate=function(e,t,i){var n=this,a=t.chid,o=t.media_id,r=t.isDirectCall,s=t.lsuid,c=this.container,d=c.commonImpl,t=c.detailsHandler,l=this.states[a],p=l.audio.is_invited;EmbedSound.stop(),l&&l.audio?(this.invitations=p?null:this.invitations,$.extend(!0,l,{audio:{status:i}}),"rejected"!=i&&"missed"!=i||r||this.setCallUIposition(".zsiq_media_headshot_main"),setTimeout(function(){var e=l.isDirectCall;delete l.audio,n.__updateState(a),n.__checkAndDestroyInstance(a),p||-1==["rejected","missed"].indexOf(i)||n.__recordSound(a,e,s,i),e&&"ended"==i&&n.implementRatingUI(a),e&&"cancelled"==i&&n.directCallCancelled()},500),this.__updateState(a),c=d.checkCallHostType({chid:a,mid:o,hostType:"downstream"})&&["cancelled","rejected","missed"].includes(i)?v.activity.MEDIA_AUDIO_INVITATION_CLEARED:v.activity.MEDIA_AUDIO_UI_CLEARED,d.sendMediaActivity({param:{action_type:c,add_info:t.getMediaActivityAddInfo()},mid:o}),r&&(this.stopSoundNotification(),clearTimeout(t.getChatWinObjById(a).waitTimer))):l&&this.__checkAndDestroyInstance(a)},H.prototype.__checkAndDestroyInstance=function(e){try{var t=Object.keys(this.states[e]);0==["audio","screen_share"].filter(function(e){return-1!=t.indexOf(e)}).length&&(this.stopTimer(e),delete this.states[e])}catch(e){}},H.prototype.setCallUIposition=function(e){var t=this.container.detailsHandler.getBody().find(e);t[0]&&(e=getComputedStyle(t[0]),t=parseInt(e.getPropertyValue("left"))||0,e=parseInt(e.getPropertyValue("top"))||0,this.container.commonImpl.setCallUIPosition(e,t))},H.prototype.showScreenShareInvitation=function(e){var t=e.chid,i=e.rejectCbk,n=e.acceptCbk,a=e.media_id,o=this.container,r=o.commonImpl,s=o.detailsHandler;this.initiateHeadshot(t);function c(){s.clearConformBox()&&r.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_CONFIRMBOX_CLEARED,add_info:s.getMediaActivityAddInfo()},mid:a}),n()}function d(e){void 0===e&&(e=!0),s.clearConformBox()&&r.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_CONFIRMBOX_CLEARED,add_info:s.getMediaActivityAddInfo()},mid:a}),e&&i()}var l,p;p=(l={name:M,acceptHandler:c,rejectHandler:d,chid:t}).name,e=l.acceptHandler,o=l.rejectHandler,l=l.chid,o=u(y("div",{class:"zsiq_popup",id:"zsiqssconfirmbox"},y("div",{class:"zsiq_popupsub"},y("em",{class:"siqico-close zsiq_center",onClick:o}),y("em",{class:"siqico-screenshare zsiq_popuplogo"}),y("div",{class:"zsiq_popup_hdr"},LSResource.getRealValue("common.screensharerequest")),y("div",{class:"zsiq_popup_desc"},LSResource.getRealValue("screenshare.request.desc",p(l))),y("div",{class:"zsiq_popup_btn zsiq_center"},y("span",{class:"zsiq_center",id:"zsiqconfirmss",onClick:e},LSResource.getRealValue("common.share")),y("span",{class:"zsiq_center zsiq_cancelbtn",id:"zsiqdecliness",onClick:o},LSResource.getRealValue("common.decline")))))),$(q()).append(o),r.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_CONFIRMBOX_SHOWN,add_info:s.getMediaActivityAddInfo()},mid:a}),this.ss_invitation[t]={rejectHandler:d,acceptHandler:c,media_id:a,template:o}},H.prototype.showScreenShareMaking=function(e,t){var i=t.chid,n=t.cancelCbk,a=t.media_id,o=t.ss_type;this.initiateHeadshot(i);t=this.states[i],o=o||(0==this.container.screenShareImpl.getScreenShareType(i,a)?"sharing":"viewing");$.extend(!0,t,{handler:this.handleActionHandler.bind(this),name:M,url:k,chid:i,screen_share:{media_id:a,reject_cbk:n,status:"requested",type:o}}),this.__updateState(i)},H.prototype.makeScreenShareConnecting=function(e,t){var i=t.chid,n=t.muteCbk,a=t.rejectCbk,o=t.media_id;t.name;U[i]=T(i).attendername,this.initiateHeadshot(i);var r=this.states[i],t=0==this.container.screenShareImpl.getScreenShareType(i,o)?"sharing":"viewing";$.extend(!0,r,{handler:this.handleActionHandler.bind(this),name:M,url:k,chid:i,screen_share:{media_id:o,mute_cbk:n,reject_cbk:a,status:"connecting",type:t}}),this.__updateState(i)},H.prototype.makeScreenShareConnected=function(e,t){var i=this,n=t.media_id,a=t.chid,o=t.callEndCbk,r=t.ss_type;U[a]=T(a).attendername,this.initiateHeadshot(a);t=this.states[a],r=r||(0==this.container.screenShareImpl.getScreenShareType(a,n)?"sharing":"viewing");$.extend(!0,t,{handler:this.handleActionHandler.bind(this),name:M,url:k,screen_share:{reject_cbk:o,status:"connected",connected_time:(new Date).getTime(),type:r,swap_cbk:function(){return i.__swapScreen(i.container.commonImpl.getActiveMediaID(a),a)}}}),setTimeout(this.startTimer.bind(this,a,e),500),this.__updateState(a)},H.prototype.makeScreenShareReconnecting=function(e,t){this.__makeReconnecting(e,t)},H.prototype.makeScreenShareEnded=function(e,t){this.__ssTerminate(e,t,"ended")},H.prototype.makeScreenShareCancelled=function(e,t){this.__ssTerminate(e,t,"cancelled")},H.prototype.makeScreenShareRejected=function(e,t){this.__ssTerminate(e,t,"rejected")},H.prototype.makeScreenShareMissed=function(e,t){this.__ssTerminate(e,t,"missed")},H.prototype.__ssTerminate=function(e,t,i){var n=this,a=t.chid,o=(t.media_id,this.states[a]);this.ss_invitation[a]&&(this.ss_invitation[a].rejectHandler(!1),delete this.ss_invitation[a]),o&&o.screen_share?($.extend(!0,o,{screen_share:{status:i}}),setTimeout(function(){delete o.screen_share,n.__updateState(a),n.__checkAndDestroyInstance(a),n.deletePlayer(a)},500),this.__updateState(a)):o&&this.__checkAndDestroyInstance(a)},H.prototype.showDialog=function(){},H.prototype.enableOutingCallUI=function(){},H.prototype.handleActionHandler=function(e,t,i){i=this.states[e]&&this.states[e][t]&&this.states[e][t][i+"_cbk"];i&&i.call(this)},H.prototype.getTimeDiff=function(e){var t=(new Date).getTime()-e,e=(e=Math.floor(t%36e5/6e4))<10?"0"+e:e,t=(t=Math.floor(t%6e4/1e3))<10?"0"+t:t;return isFinite(e)&&isFinite(t)?e+":"+t:""},H.prototype.startTimer=function(t,e){var i,n=this;this.states[t].timer_ref||(i=this.states[t][e].connected_time,this.states[t].timer_ref=setInterval(function(){var e=n.states[t];$.extend(!0,e,{timer:n.getTimeDiff(i)}),n.__updateState(t)},1e3))},H.prototype.stopTimer=function(e){e=this.states[e];clearInterval(e.timer_ref),delete e.timer,this.__updateState(e.chid)},H.prototype.playSoundNotification=function(e,t){void 0===e&&(e="incomingcall"),void 0===t&&(t="audiocall");e={type:t,duration:this.container.constants.WAITING_TIME_SECS,tone:e};this.container.detailsHandler.playNotifSound(e)},H.prototype.stopSoundNotification=function(){this.container.detailsHandler.stopNotifSound()},H.prototype.__updateState=function(e){e=this.states[e];e&&[e.headshot,e.headshotInvite,e.player,e.directCallUI].forEach(function(e){e&&e.updateState()}),this.handleMinimizeState()},H.prototype.__swapScreen=function(t,e){var i=this,n=this.container.detailsHandler,a=(this.container.detailsHandler.getEncryChid(e),T(e),function(e){"Escape"===e.key&&($(q()).find(".zsiq_media_popup").remove(),window.parent.removeEventListener("keydown",a),i.container.commonImpl.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_POPUP_CLEARED,add_info:n.getMediaActivityAddInfo()},mid:t}))}),o=u(y("div",{class:"zsiq_media_popup"},y("span",null,LSResource.getRealValue("screenshare.swap.sharing")),y("div",{class:"zsiq_media_btn"},y("span",{onClick:function(){i.container.audioImpl.addScreenShareTrack({chid:e,id:t}),window.parent.removeEventListener("keydown",a),$(o).remove(),i.container.commonImpl.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_POPUP_CLEARED,add_info:n.getMediaActivityAddInfo()},mid:t})}},LSResource.getRealValue("common.continue")),y("span",{class:"zsiq_media_cancelbtn",onClick:function(){window.parent.removeEventListener("keydown",a),$(o).remove(),i.container.commonImpl.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_POPUP_CLEARED,add_info:n.getMediaActivityAddInfo()},mid:t})}},LSResource.getRealValue("common.cancel")))));$(q()).append(o),this.container.commonImpl.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_POPUP_SHOWN,add_info:this.container.detailsHandler.getMediaActivityAddInfo()},mid:t}),window.parent.addEventListener("keydown",a),window.parent.focus()},H.prototype.__makeReconnecting=function(e,t){var i=t.chid,t=t.media_id;this.states[i][e="viewing"==this.getCurrentScreenshareType(i)?"screen_share":e].status="reconnecting",this.__updateState(i);e="audio"==e?v.activity.MEDIA_AUDIO_RECONNECT_STATE:v.activity.MEDIA_SCREENSHARE_RECONNECT_STATE;this.container.commonImpl.sendMediaActivity({param:{action_type:e},mid:t})},H.prototype.shareScreen=function(e){var t=this.container,i=t.audioImpl,n=t.commonImpl,t=(t.dataHandler,n.getCallStatusByChid(e)),t=Object.keys(t)[0];n.sendMediaActivity({param:{action_type:v.activity.MEDIA_SCREENSHARE_SHARESCREEN},mid:t}),i.addScreenShareTrack({chid:e,id:t})},H.prototype.mediaPermissionUI=function(){var e,t,i=(e=getBrowserFromUserAgent(navigator.userAgent).split("-")[0],t=u(y("div",{class:"zsiq_prv_main zsiq-cal-turtrp",id:"allowmicbannerui",onClick:function(){return $(t).remove()}},y("div",{class:"zsiq-cal-hnt-cont "+("Chrome"==e?"":"zsiq-"+e)},y("div",{class:"zsiq-trtp-anim"}),y("span",{class:"siqico-arrow zsiq-arrow"}),y("span",{class:"zsiq-alw-mic siqico-mic"}),y("div",{class:"zsiq-alw-mic-desc",html:LSResource.getRealValue("av.info.pleaseallowmicrophone")})))));return $(q()).append(i),function(){return $(i).remove()}},H.prototype.mediaPermissionUnlock=function(){var e,t,i=(e=getBrowserFromUserAgent(navigator.userAgent).split("-")[0],t=u(y("div",{class:"zsiq_prv_main zsiq-cal-turtrp",onClick:function(){return $(t).remove()}},y("div",{class:"zsiq-cal-hnt-cont zsiq-isblk "+("Chrome"==e?"":"zsiq-"+e)},y("div",{class:"zsiq-trtp-anim "}),y("span",{class:"siqico-arrow zsiq-arrow"}),y("div",{html:LSResource.getRealValue("av.info.pleasetaponlock","<em class='siqico-lock'></em>")}),y("p",null,"(",LSResource.getRealValue("common.or"),")"),y("div",null,LSResource.getRealValue("av.info.enablemicrophonesetting")),y("div",{class:"calndr-sedulbtn",style:"",onclick:_}," ",LSResource.getRealValue("chatwindow.mailcopy.clickhere")," ")))));return $(q()).append(i),$(q()).find("#allowmicbannerui").remove(),$UI.showBanner(LSResource.getRealValue("av.info.microphone.blocked"),!0,null,8e3),function(){return $(i).remove()}},H.prototype.handleCallClash=function(e){e()},H.prototype.handleMinimizeState=function(){var e=this.invitations,t=this.container.commonImpl.getActiveCallData();e||t?($Support.getParent().$ZSIQWidgetUI.updateCallUI(),e?$Support.getParent().$ZSIQWidgetUI.updateIncomingCallUI():$Support.getParent().$ZSIQWidgetUI.removeIncomingCallUI()):$Support.getParent().$ZSIQWidgetUI.removeCallUI()},H.prototype.forceEndCall=function(){for(var e in this.states)this.container.commonImpl.endCallByChid(e),this.container.detailsHandler.triggerIconCheck(e)},H.prototype.implementRatingUI=function(e){var t,i,i=(i=e,u(y("div",{class:"cal-wrap",id:"audiocal"},y("div",{class:"posrel dib-mid"},y("div",{class:"cal-widgt theme1 outcal"},y("div",{class:"posrel usr-imginfo"},y("div",{class:"cal-visimg "},y("img",{src:(t=k)&&t(0,i),alt:"Operator"}))),y("div",{class:"cal-vstrdetl textC"},y("nav",{class:"cal-actvevstr elips font16"},LSResource.getRealValue("av.info.rating")),y("div",{class:"rating font18"},y("span",{class:"reaction_ico sad_icon","data-reaction":"sad",documentclick:"sendCallRating",title:LSResource.getRealValue("common.sad")}),y("span",{class:"reaction_ico neutral_icon","data-reaction":"neutral",documentclick:"sendCallRating",title:LSResource.getRealValue("common.neutral")}),y("span",{class:"reaction_ico happy_icon","data-reaction":"happy",documentclick:"sendCallRating",title:LSResource.getRealValue("common.happy")})),y("p",{class:"c777 font14"},LSResource.getRealValue("ne.rating.byline"))))))));CallImpl.isCallWithChat=this.container.detailsHandler.getEncryChid(e),SiqAVRouter.chatwinobj=this.container.detailsHandler.getChatWinObjById(e),this.container.detailsHandler.getChatWinObjById(e).hideMaskDiv(),JSON.parse($Support.EmbedObj.eprops.reaction[0])?($("#audiorec,#audiocal").remove(),$("body").prepend(i)):this.implementRatingFdbkUI(SiqAVRouter.chatwinobj)},H.prototype.implementRatingFdbkUI=function(e){var t,i,n,a,t=(t=e,i=k,n=M,a=ZSIQConversationManager.getChatWinObjById(t.chatID).RCHID,e=$Support.isSignature($Support.EmbedObj),u(y("div",{class:"cal-wrap",id:"audiocal"},y("div",{class:"adocal-cont dtfix "+D()+" cal-oflne",style:"height:354px;"},A(null,t),y("div",{class:"header"},e?"":y("div",{class:"actbtn"},y("em",{class:"sqico-min siq-minimize-icon",title:LSResource.getRealValue("ne.title.minimize"),documentclick:"min_iframe"})),y("div",{class:"posrel dib-mid"},y("div",{class:"cal-visimg sqico-user"},y("img",{src:i&&i(0,a),alt:n?n(a):"Operator"})),t.rating?y("em",{class:"reaction_ico "+t.rating+"_icon usr-rtng"}):""),y("div",null,y("div",{class:"cal-cmpname font20 fontB"},n(a)))),y("div",{class:"cal-bodycont posrel"},t.rating?y("div",{class:"ofln-msg mT5"}," ",$Support.getReactionIndex(t.rating)," "):""),y("div",{class:"cal-footer",style:"height:70px;"},y("textarea",{class:"bg-f6 font13 c333 lH20",dockeyup:"feedback",dockeydown:"textarea",id:"fdbkarea","data-validate":"required",placeholder:LSResource.getRealValue("av.info.fdkbckmsg"),autofocus:"",style:"overflow: hidden;"}),y("div",{class:"sqico-calsend fdbak-send msg-send",documentclick:"sendCallFb",title:LSResource.getRealValue("embed.submit")}))))));JSON.parse($Support.EmbedObj.eprops.feedback[0])?($($Support.getParent().document.body).find(".siqembed").removeClass("zsiq_size2"),$Support.getParent().$ZSIQWidgetUI.handlefbCall(),$("#audiorec,#audiocal").remove(),$("body").prepend(t)):this.directCallCancelled()},H.prototype.implementFdbkSuccessUI=function(e){var t,i,n,a,t=(t=e,i=k,n=M,a=ZSIQConversationManager.getChatWinObjById(t.chatID).RCHID,e=$Support.isSignature($Support.EmbedObj),u(y("div",{class:"cal-wrap",id:"audiocal"},y("div",{class:"adocal-cont dtfix "+D()+" cal-oflne"},A(null,t),y("div",{class:"header"},e?"":y("div",{class:"actbtn"},y("em",{class:"sqico-min siq-minimize-icon",title:LSResource.getRealValue("ne.title.minimize"),documentclick:"min_iframe"})),y("div",{class:"posrel dib-mid"},y("div",{class:"cal-visimg sqico-user"},y("img",{src:i&&i(0,a),alt:n?n(a):"Operator"})),t.rating?y("em",{class:"reaction_ico "+t.rating+"_icon usr-rtng",title:t.rating}):""),y("div",null,y("div",{class:"cal-cmpname font20 fontB"},n(a)))),y("div",{class:"cal-bodycont posrel"},y("div",{class:"ofln-msg mT5"},LSResource.getRealValue(t.rating?"av.info.ratingandfbk":"faq.feedback")),y("div",{class:"sqico-call bg-grn mT25 mA",title:LSResource.getRealValue("av.info.callagain"),onclick:function(){return parent.$zohosq.call.start()}}))))));$Support.getParent().$ZSIQWidgetUI.handleMinCall(),$("#audiorec,#audiocal").remove(),$("body").prepend(t)},H.prototype.directCallCancelled=function(){$("#audiorec,#audiocal").remove(),$("body").prepend(CallUIHandler.getCallCancelledHtml()),$Support.isSignature($Support.EmbedObj)&&$("div.actbtn").remove(),$($Support.getParent().document.body).find(".siqembed").removeClass("zsiq_size2"),$Support.getParent().$ZSIQWidgetUI.handleMinCall()},H.prototype.deleteScreenShareState=function(e){this.states[e].screen_share&&delete this.states[e].screen_share},H.prototype.deletePlayer=function(e){this.states[e]&&this.states[e].player&&(clearTimeout(this.states[e].player.showCntrlTimer),delete this.states[e].player)},H.prototype.clearAllStates=function(e){this.states[e]&&delete this.states[e]},H.prototype.getCurrentScreenshareType=function(e){e=this.states[e];return e&&e.screen_share&&e.screen_share.type?e.screen_share.type:null};function N(e){this.container=e}N.prototype.post=function(e,t,i,n){this.request("POST",e,t,i,n)},N.prototype.get=function(e,t,i){this.request("GET",url,e,t,i)},N.prototype.request=function(e,t,i,n,a){var o=_SCHEMA+"://"+_EMBEDSERVERURL+"/visitor/v2/"+_SCREENNAME+"/"+t;try{$.ajax({url:o,type:e,data:i,success:n||function(){},error:a||function(){}})}catch(e){}};function P(e){this.container=e,this.uiutil=$Support,this.isembed=!0,this.isoldUI=!1}P.prototype.isOldUI=function(){return this.isoldUI},P.prototype.handleEndSession=function(e,t){this.onGoingCallForChat(e)?this.container.commonImpl.endCallByChid(e,t):t()},P.prototype.onGoingCallForChat=function(e){return!!this.container.commonImpl.getCallStatusByChid(e)},P.prototype.getEncryChid=function(e){return $Support.chidmappinglist[e]},P.prototype.isEmbed=function(){return this.isembed},P.prototype.getChatWinObjById=function(e,t){void 0===t&&(t=!1);e=t?e:this.getEncryChid(e);return ZSIQConversationManager.getChatWinObjById(e)},P.prototype.getSupportReps=function(e,t){void 0===t&&(t=!1);e=t?e:this.getEncryChid(e);return SUPPORT_REPS[e]||null},P.prototype.getSupportRepCount=function(e,t){void 0===t&&(t=!1);t=this.getSupportReps(e,t);return t&&Object.keys(t).length},P.prototype.isGroupConversation=function(e,t){void 0===t&&(t=!1);try{return 1<this.getSupportRepCount(e,t)}catch(e){return!1}},P.prototype.isAttenderBot=function(e,t){return void 0===t&&(t=!1),this.getChatWinObjById(e,t).isBotChat},P.prototype.isChatExist=function(e,t){return void 0===t&&(t=!1),this.getChatWinObjById(e,t).isAudioCallAllowed()},P.prototype.getAttenderId=function(e,t){return void 0===t&&(t=!1),this.getChatWinObjById(e,t).attender},P.prototype.isProactiveChat=function(e,t){return void 0===t&&(t=!1),this.getChatWinObjById(e,t).proactive},P.prototype.getCurrentUserId=function(){return null},P.prototype.playNotifSound=function(e){var t=e.tone,i=e.duration,n=e.chatid,e=e.isEncrypted,e=!n||this.getChatWinObjById(n,e);n&&e.isSoundOff()||EmbedSound.play(t,i)},P.prototype.stopNotifSound=function(){EmbedSound.stop()},P.prototype.initMissedChat=function(e,t,i,n){e=e?this.getChatWinObjById(e):ZSIQConversationManager.getcurrchatwinobj();delete $Support.requestRunning_missedvisitor,this.uiutil.handleMissed(t,i,n,e),this.uiutil.removeWtimeCookie(e.chatID),delete e.reopenwaiting,$Support.removeBroadCast()},P.prototype.clearPlayer=function(){var e=this.getBody().find(".zsiq_media_videomain");return 0<e.length&&(e.remove(),!0)},P.prototype.clearAudioUI=function(){var e=this.getBody().find(".zsiq_media_headshot_main");e&&e[0]&&"user_busy"!=e[0].id&&e.remove()},P.prototype.clearConformBox=function(){var e=this.getBody().find("#zsiqssconfirmbox");return 0<e.length&&(e.remove(),!0)},P.prototype.clearPopup=function(){var e=this.getBody().find(".zsiq_media_popup");return 0<e.length&&(e.remove(),!0)},P.prototype.clearBusyUI=function(){var e=this.getBody().find("#user_busy");return 0<e.length&&(e.remove(),!0)},P.prototype.getBody=function(){return $(parent.document.body)},P.prototype.triggerAudioCallIcon=function(e,t){var i=$("#audiocall");"show"==t?(this.showAudioCall(),i.removeClass("cmn_disable").show(),i.show().parent().addClass("rgt_ico")):"hide"==t?(this.hideAudioCall(),i.hide().parent().removeClass("rgt_ico")):"disable"==t&&(this.showAudioCall(),i.addClass("cmn_disable"))},P.prototype.triggerScreenShareIcon=function(){},P.prototype.showAudioCall=function(){$("#audiocall").show(),$(".callagain-txt").show()},P.prototype.hideAudioCall=function(){$("#audiocall").hide(),$(".callagain-txt").hide()},P.prototype.isAudioCallEnabled=function(){var e="true"==$Support.getParent().$ZSIQChat.getWidgetData().embedobj.isaudiocallallowed,t="true"==$Support.EmbedObj.eprops.isaudiocall;return e&&t},P.prototype.isPlanAllowed=function(){return Licence.verify("audiocall")},P.prototype.isScreenShareAllowed=function(){return CommonUtil.isScreenshareEnabledFromPortal()&&$Support.EmbedObj.eprops.ischannelscreenshare&&Licence.verify("issiqscreenshare")},P.prototype.hasIncomingCall=function(e){var t,i=this.container.commonImpl.getCallStatusByChid(e);for(t in i){var n=i[t];if("audio"==n.type&&"incoming"==n.callType&&"ringing"==n.callStatus)return!0}return!1},P.prototype.isActiveBySSType=function(e){var t={isActive:!1,id:null},i=this.container.commonImpl.getActiveCallData();if(!i)return t;if(i==e){var n,a=this.container.commonImpl.getCallStatusByChid(i);for(n in a){var o=a[n].type,r=a[n].id;if("screen_share"==o)return t.isActive=!0,t.id=r,t}}return t},P.prototype.isShareScreenAllowed=function(e){if(!this.container.commonImpl.currentUserBrowserSupportSS())return!1;var t=this.isActiveBySSType(e),i=t.isActive,t=t.id;return 0!=this.container.screen_shareImpl.getScreenShareType(e,t)||!i},P.prototype.checkIsSSOnGoing=function(e,t){var i=this.container.commonImpl.getActiveCallData();return!!i&&(i!=e||("share_screen"==t?this.isShareScreenAllowed(e):"view_screen"==t?this.isRequestScreenShareAllowed(e):void 0))},P.prototype.checkActiveScreenShare=function(e,t){var i,n=this.container.commonImpl.getCallStatusByChid(e);for(i in n){var a=n[i],o=a.id;if("screen_share"==a.type){a=this.container.screenShareImpl.getScreenShareType(e,o);if(1==a)return this.container.screenShareImpl.handleUIEnd({type:"screen_share",id:o,chatid:e}),this.container.screenShareImpl.startScreenShare(t),!0;if(0==a)return this.container.screenShareImpl.handleUIEnd({type:"screen_share",id:o,chatid:e}),this.container.screenShareImpl.startScreenShare(t),!0}}return!1},P.prototype.isSecureConnection=function(){return-1<window.location.protocol.indexOf("https")},P.prototype.isAudioRecordingSupported=function(){return window.AudioContext=window.AudioContext||window.webkitAudioContext,window.URL=window.URL||window.webkitURL,navigator.getUserMedia=this.container.MediaPermission.getUserMediaDetail(),window.AudioContext&&navigator.getUserMedia&&window.URL&&window.Worker||(support=!1),!0},P.prototype.closeViewMediaPermission=function(){$(window.parent.document).find("body").find(".zsiq_prv_main").remove()},P.prototype.isliveChatWindow=function(){return"msgarea"==$Support.container.attr("cwview")},P.prototype.isFaceBookIntegration=function(){return-1<window.location.href.lastIndexOf("facebook.ext")},P.prototype.getVisitorWMSID=function(){return this.uiutil.EmbedObj.vwmsid},P.prototype.getLsid=function(){return $Support.getParent().$ZSIQWidget.getWidgetObject().lsid},P.prototype.getDecodedText=function(e){return"function"==typeof getUnescapedText?getUnescapedText(e):e},P.prototype.getVisitorID=function(){},P.prototype.getVisitorBrowser=function(){},P.prototype.getVisitorUserAgent=function(){},P.prototype.getVisitorPage=function(){},P.prototype.getUTSDetail=function(){},P.prototype.isMobileVisitor=function(){},P.prototype.isIOSSDKVisitor=function(){},P.prototype.isChatMonitor=function(){return!1},P.prototype.getCurretUserLSUID=function(){},P.prototype.I18N=function(){},P.prototype.getChatAttender=function(){},P.prototype.isVisitorOnline=function(){},P.prototype.isOngoingChat=function(){return!1},P.prototype.checkBrowserSupported=function(){},P.prototype.getBrowserFromUserAgent=function(){},P.prototype.addVisitorDetail=function(){},P.prototype.pickupsupport=function(){},P.prototype.endSession=function(e){e=e?this.getChatWinObjById(e):ZSIQConversationManager.getcurrchatwinobj();$Support.quitChat(e)},P.prototype.getChatIdByVisitorId=function(){},P.prototype.isScreenShareEnabled=function(){},P.prototype.sendDebugLogger=function(){},P.prototype.hideAudioCallIcon=function(){},P.prototype.showAudioCallIcon=function(){},P.prototype.disableCallAgainOption=function(){},P.prototype.showCallAgainOption=function(){},P.prototype.removeAudioCallIcon=function(){},P.prototype.isCallIconEnabled=function(){},P.prototype.initVideoPlayer=function(){},P.prototype.isAllowedForCurrTab=function(){},P.prototype.getRepresentative=function(){},P.prototype.isVisitorBrowserSupported=function(){},P.prototype.isVisitorOSSupported=function(){},P.prototype.getVisitorOS=function(){},P.prototype.audioIconStatus=function(){},P.prototype.screenshareIconStatus=function(){},P.prototype.triggerIconCheck=function(e){try{this.container.audioImpl.audioIconStatus(e,this.triggerAudioCallIcon.bind(this))}catch(e){}},P.prototype.focusChatWindow=function(){},P.prototype.joinChat=function(){},P.prototype.canShowAudioCallInvitation=function(){return!0},P.prototype.endCall=function(e,t){this.container.commonImpl.endCallByChid(e,t)},P.prototype.isAudioCallDisabled=function(){return!1},P.prototype.toJSON=function(e){return JSON.stringify(e)},P.prototype.handleCallInitiate=function(e){this.clearChatEndTimer(e)},P.prototype.handleCallEnded=function(){},P.prototype.handleCallCancelled=function(){},P.prototype.handleCallRejected=function(){},P.prototype.handleCallMissed=function(){},P.prototype.handleIncomingCall=function(e){this.clearChatEndTimer(e)},P.prototype.handleIncomingAccept=function(e){this.clearChatEndTimer(e)},P.prototype.handleOutgoingAccept=function(e){this.clearChatEndTimer(e)},P.prototype.isCallInitiatedFromOldUI=function(){return this.container.commonImpl.getIsCallInitiatedFromOldUI()},P.prototype.clearChatEndTimer=function(e){e=this.getChatWinObjById(e.chid);e&&e.endtimer&&($Support.clearEndTimer(e),this.stopNotifSound())},P.prototype.isTabFocused=function(){return parent.document.hasFocus()},P.prototype.getSessionID=function(){return getSid()},P.prototype.getMediaActivityAddInfo=function(){return+this.isTabFocused()+" | "+this.getSessionID()};function L(e){this.container=e,this.init(e)}L.prototype.handle=function(e){this.route(e.param)},L.prototype.route=function(e){var t=e.msg.media,i=t.type,n=t.chatid,a=t.id,o=t.negotiationType,r=e.msg,t=r.operation;r.cbtype;this.checkIsCurrentTab(n)||-1!=["call_initiate","call_cancel","call_miss"].indexOf(t)?s(o=(t=this.getController(o||i))&&t[this.getHandler(e)])&&(o.call(t,e.msg.media),this.container.commonImpl.sendMediaStats(e,null)):(this.container.uiHandler.clearAudioCallInvite(i,a,n),this.container[i+"Impl"].clearData(e.msg.media),Sound.stop())},L.prototype.init=function(e){this.audio_impl=e.audioImpl,this.video_impl=e.videoImpl,this.screen_share_impl=e.screenShareImpl,this.screen_view_impl=e.screen_viewImpl,this.common_impl=e.commonImpl},L.prototype.getController=function(e){return this[e+"_impl"]},L.prototype.getHandler=function(e){var t=e.msg,i=t.cbtype,e=t.status,t=t.operation,e=this.getStatus(e),t=this.getOperations(t),i=this.getCBTypes(i);return e||t||i},L.prototype.getOperations=function(e){return{call_credential:"setCredential",call_initiate:"handleInvitation",call_accept:"handleCallAccept",call_reject:"handleCallReject",call_candidates:"handleCandidates",call_answer:"handleCallAnswer",call_end:"handleCallEnd",call_offer:"handleCallOffer",call_cancel:"handleCallCancel",call_miss:"handleCallMissed",call_invite:"handleCallInvite",call_request:"handleCallRequest"}[e]},L.prototype.getCBTypes=function(){return{credential:"setCredential",invite:"handleInvitation",reject:"handleCallReject",candidate:"handleCandidates",answer:"handleCallAnswer",offer:"handleCallOffer",cancel:"handleCallCancel",miss:"handleCallMissed",invite:"handleCallInvite"}},L.prototype.getStatus=function(e){return{accept:"handleCallAccept",end:"handleCallEnd"}[e]},L.prototype.checkIsCurrentTab=function(){return Boolean(this.container.commonImpl.getActiveTab())};function j(){this.container=this.container}j.prototype.getEventsMap=function(){return{mute:"",end_media:"",sharescreen:"",shareaudio:"",stop_audio:"",stop_screenshare:""}};function B(e){this.container=e,this.init(e)}B.prototype.handle=function(){},B.prototype.init=function(){};function z(e){this.conatiner=e}z.prototype.handle=function(){};function x(e){((this.container=e).MediaPermission=this).isSupported=void 0!==navigator.mediaDevices&&void 0!==navigator.mediaDevices.getUserMedia,this.displayMediaSupported=this.isSupported&&navigator.mediaDevices.getDisplayMedia&&void 0!==navigator.mediaDevices.getDisplayMedia,this.init(),this.getmediaDevices(this.updateMediaDevices.bind(this),null)}x.prototype.init=function(){this.type={audio:"audio",video:"video",audio_video:"audio_video",screen:"screen_share"},this.streamType={audio:1,video:2,screen:3,audio_video:4},this.streamTypeInString={1:"audio",2:"video",3:"screen_share",4:"audio_video"},this.devicesType={audioInput:"audioinput",videoInput:"videoinput",audioOutput:"audiooutput"}},x.prototype.isDisplayMediaSupported=function(){return this.displayMediaSupported},x.prototype.updateMediaDevices=function(e){this.devicesArray=e;var t,i=[],n=[];for(t in this.devicesArray){var a=this.devicesArray[t];a.kind==this.devicesType.audioInput?i.push(a):a.kind==this.devicesType.videoInput&&n.push(a)}this.availableDevices={audioInput:i,videoInput:n}},x.prototype.getAvailableDevices=function(){return this.availableDevices},x.prototype.getmediaDevices=function(t){void 0!==navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices().then(function(e){return t(e)})},x.prototype.updatePreferredDevice=function(e){this.preferredDevice||(this.preferredDevice={}),this.preferredDevice[e.type]=e},x.prototype.getPreferredDevice=function(e){return this.preferredDevice?this.preferredDevice[e]:null},x.prototype.getAudioInputDevices=function(){return this.availableDevices.audioInput},x.prototype.getVideoInputDevices=function(){return this.availableDevices.videoInput},x.prototype.getMediaConstraints=function(e,t){var i={},n=!0,a=!0,o=this.getPreferredDevice(this.devicesType.audioInput),r=this.getPreferredDevice(this.devicesType.videoInput);return o&&(n={deviceId:{exact:o.deviceId}}),r&&(a={deviceId:{exact:r.deviceId}}),i=Object.assign({},{audio:n,video:a},t),e==this.type.audio?i.video=!1:e!=this.type.video&&e!=this.type.screen||(i.audio=!1),i},x.prototype.requestStream=function(t,i,n,e,a,o){var r=this,s=null;this.streams?s=this.streams[t]:this.streams=[],s&&t!=this.type.screen?i():(a=a?navigator.mediaDevices.getDisplayMedia:navigator.mediaDevices.getUserMedia,e=this.getMediaConstraints(t,e),a.call(navigator.mediaDevices,e).then(function(e){r.setType(e,t),r.streams[t]=e,"function"!=typeof o||(e=e._getPrimaryVideoTrack())&&(e.onended=o),i()}).catch(function(e){n(e,t)}))},x.prototype.getAudioStream=function(e,t,i,n){this.requestStream(this.type.audio,e,t,i,!1,n)},x.prototype.getVideoStream=function(e,t,i,n){this.requestStream(this.type.video,e,t,i,!1,n)},x.prototype.getScreenShareStream=function(e,t,i,n){this.displayMediaSupported?this.requestStream(this.type.screen,e,t,i,!0,n):(i={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:sourceId}}},this.requestStream(this.type.screen,e,t,i,!1,n))},x.prototype.getStreamByType=function(e){return this.streams?this.streams[e]:null},x.prototype.getScreenSharePermissionWithAudio=function(){},x.prototype.getAudioPermission=function(e,t){this.getPermission(this.type.audio,e,t)},x.prototype.getVideoPermission=function(e,t){this.getPermission(this.type.video,e,t)},x.prototype.getPermission=function(e,t,i){navigator.permissions.query({name:e}).then(function(e){"function"==typeof t&&t(e.state)}).catch(function(e){"function"==typeof i&&i(e)})},x.prototype.setType=function(e,t){var i="";return e.salesiq||(i=e.salesiq={}),i._type=t,i},x.prototype.getTypeFromStream=function(e){return e&&e.salesiq&&e.salesiq._type?e.salesiq._type:null},x.prototype.closeAllStream=function(){for(var e in this.streams)this.closeStream(e)},x.prototype.closeStreamByType=function(e){this.closeStream(e)},x.prototype.closeStream=function(e){var t=this.streams?this.streams[e]:null;if(t){var i,n=t.getTracks();for(i in n)n[i].stop();this.streams[e]=null}},x.prototype.toggleMute=function(){var e=this.streams[this.type.audio];e.getAudioTracks()[0].enabled=!e.getAudioTracks()[0].enabled,this.container.commonImpl.sendMediaActivity({param:{action_type:e.getAudioTracks()[0].enabled?v.activity.MEDIA_AUDIO_UNMUTE:v.activity.MEDIA_AUDIO_MUTE}})},x.prototype.screenEndFromBrowserUI=function(e){this.streams[this.type.screen].getVideoTracks()[0].onended=function(){e()}},x.prototype.getUserMediaDetail=function(){return navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||null},x.prototype.getTracksId=function(){var e,t={};for(e in this.streams)t[e]=this.streams[e]&&this.streams[e].id;return t};function V(e){this.container=e,this.userAgent=navigator.userAgent,this.browserName=null,this.browserVersion=null,this.browserSupported=!1,(e.MediaDetails=this).platform=navigator.platform,this.setBrowserName()}V.prototype.setBrowserName=function(){var e,t,i,n,t=(e=this.userAgent,t="unknown-unknown",-1<(n=(i=e).toLowerCase()).indexOf("msie")?t=(e=i.substring(i.indexOf("MSIE")).split(";")[0]).split(" ")[0].replace("MSIE","IE")+"-"+e.split(" ")[1]:-1<n.indexOf("edge")?t=i.substring(i.indexOf("Edge")).split(" ")[0].replace("/","-"):-1<n.indexOf("safari")&&-1<n.indexOf("version")?t=i.substring(i.indexOf("Safari")).split(" ")[0].split("/")[0]+"-"+i.substring(i.indexOf("Version")).split(" ")[0].split("/")[1]:-1<n.indexOf("opr")||-1<n.indexOf("opera")?-1<n.indexOf("opera")?t=i.substring(i.indexOf("Opera")).split(" ")[0].split("/")[0]+"-"+i.substring(i.indexOf("Version")).split(" ")[0].split("/")[1]:-1<n.indexOf("opr")&&(t=i.substring(i.indexOf("OPR")).split(" ")[0].replace("/","-").replace("OPR","Opera")):-1<n.indexOf("chrome")?t=i.substring(i.indexOf("Chrome")).split(" ")[0].replace("/","-"):-1<n.indexOf("firefox")&&(t=i.substring(i.indexOf("Firefox")).split(" ")[0].replace("/","-")),[t,parseInt(t.split("-")[1])]);this.browserName=t[0],this.browserVersion=t[1]},V.prototype.getBrowserName=function(){return this.browserName},V.prototype.getBrowserVersion=function(){return this.browserVersion},V.prototype.checkBrowserSupported=function(){var e=this.browserName.split("-")[0];return this.browserSupported=!1,"Chrome"==e?this.browserSupported=23<=this.browserVersion:"Firefox"==e?this.browserSupported=22<=this.browserVersion:"Opera"==e?this.browserSupported=18<=this.browserVersion:"Safari"==e&&(this.browserSupported=11<=this.browserVersion),this.browserSupported},V.prototype.getPlatform=function(){return this.platform},V.prototype.getClientSupport=function(){var e=this.container.MediaPermission,t={perfect_renegotiation:!0,multi_stream:!0,reconnection_policy:!0};return this.__isChrome()||this.__isSafari()||this.__isOpera()?e.displayMediaSupported||(t={perfect_renegotiation:!1,multi_stream:!1,reconnection_policy:!0}):this.__isFirefox()&&(t.perfect_renegotiation=!1),t},V.prototype.__isChrome=function(){return"Chrome"==this.browserName.split("-")[0]},V.prototype.__isFirefox=function(){return"Firefox"==this.browserName.split("-")[0]},V.prototype.__isSafari=function(){return"Safari"==this.browserName.split("-")[0]},V.prototype.__isOpera=function(){return"Opera"==this.browserName.split("-")[0]};function F(e){this.data={},this.container=e,this.unique="SiqMedia_",e.dataHandler=this}F.prototype.get=function(e){this.getLocalKey(e);return this.data[e]},F.prototype.set=function(e,t){this.getLocalKey(e);this.data[e]=t},F.prototype.remove=function(e){this.getLocalKey(e);this.data[e]&&delete this.data[e]},F.prototype.getLocalKey=function(e){return this.unique+e};function W(e){(e.router=this).container=e,this.init(e)}W.prototype.init=function(e){this.rtc_router=new L(e),this.event_router=new j,this.media_router=new B(e),this.action_router=new z(e),this.MediaPermission=new x(e),this.dataHandler=new F(e),this.MediaDetails=new V(e),this.container.constants=v},W.prototype.route=function(e){if(!this.validateRouteObject(e))throw"Media Router Schema Mismatch";this.handle(e)},W.prototype.handle=function(e){try{var t=this[e.type+"_router"];t&&t.handle&&t.handle(e)}catch(e){}},W.prototype.validateRouteObject=function(t){var i={type:"string",module:"string",useCase:"string",param:"object"},n=!0;return Object.keys(i).forEach(function(e){t[e]&&typeof t[e]==i[e]||(n=!1)}),n};function G(e){(e.LSRouter=this).container=e,this.init()}G.prototype.init=function(){var e=this,t=this;this.container;this.routes={0:function(){return e.container.checkDirectCallOnload()},2:t.handleCustomMessage(),29:t.handleAVcall.bind(t),13:t.handleUserStatus.bind(t),113:t.chatEnded.bind(t),35:t.chatEnded.bind(this),114:t.handleInfoMessage.bind(this),14:t.checkForCallIcon.bind(this),15:t.checkForCallIcon.bind(this)}},G.prototype.chatEnded=function(e){e=e.msg.chid;this.container.detailsHandler.getBody().find(".zsiq_media_headshot_main").remove(),this.container.uiHandler.clearAudioCallInvite(e),this.container.detailsHandler.triggerIconCheck(e),this.container.detailsHandler.hideAudioCall(),this.container.detailsHandler.clearBusyUI()},G.prototype.handleMessage=function(e){var t,i=this.routes,n=typeof i[e.mtype];try{"function"==n?i[e.mtype].call(this,e):"object"==n&&(t=this.getModuleName(e),"function"==typeof(t=i[e.mtype][t])&&t.call(this,e))}catch(e){}},G.prototype.handleCustomMessage=function(){var e=this;return{addvisitor:e.showInvitation,acctranschat:e.endCall,closetransfer:e.checkForCallIcon,pickupsupport:e.handlePicksupport,leavesupport:e.endSupport,missedvisitor:e.missedDirectCall,joinsupport:e.joinsupport}},G.prototype.handlePicksupport=function(e){var t=e.msg,i=LSMessanger.getPrd()+"_"+$Support.getParent().$ZSIQWidget.getEmbedObject().pinfo.soid+"_"+t.attender;try{for(var n in SUPPORT_REPS[t.chid])n!=i&&delete SUPPORT_REPS[t.chid][n]}catch(e){}this.checkForCallIcon(e)},G.prototype.handlePresenceMessage=function(){return{}},G.prototype.handleLsOperations=function(e){var t={}[e.msg.msg.mode||JSON.parse(e.msg.msg).mode];"function"==typeof t&&t(e.msg)},G.prototype.handleAVcall=function(e){e.msg.msg=JSON.parse(e.msg.msg),e.msg.msg.media=JSON.parse(e.msg.msg.media),this.container.router.route({type:"rtc",module:e.msg.msg.media.type,useCase:e.msg.msg.cbtype||e.msg.msg.operation,param:e.msg})},G.prototype.getModuleName=function(t){return{2:"msg > module",114:"msg > msg > mode",700:"msg > msg > module"}[t.mtype].trim().split(/\s*\>\s*/g).forEach(function(e){return t=t[e]}),t},G.prototype.showInvitation=function(e){try{var t=e.msg,i=t.media;if(!i)return;var n,a="";for(n in i)a=JSON.parse(i[n]).type;this.container[a+"Impl"].handleApiCallInvitation(t)}catch(e){}},G.prototype.missedDirectCall=function(e){var t=e.msg,i=t.media;if(i)for(var n in i){var a=JSON.parse(i[n]),o=a.type,a={chatid:this.container.detailsHandler.getChatIdByVisitorId(t.visitorid),id:a.id,type:o};this.container[o+"Impl"].handleCallCancel(a)}},G.prototype.checkForCallIcon=function(e){var t=this.container,e=e.msg,e=e.chatid||e.chid;t.detailsHandler.triggerIconCheck(e),t.detailsHandler.isGroupConversation(e)&&this.container.detailsHandler.clearBusyUI()},G.prototype.endSupport=function(e){var t,i=e.msg,n=i.chatid||i.chid,a=this.container,o=a.detailsHandler,e=a.commonImpl,r=a.uiHandler,i=a.MediaPermission,s=a.screenShareImpl,c=a.audioImpl,d=e.getCallStatusByChid(n);for(t in d){var l=d[t],p=l.type,u=this.container[p+"Impl"],h=l.id,l={chid:n,media_id:h,type:p};r.updateCallInvitationState(p,l,"ended"),r.clearAudioCallInvite(p,h),s.handleAudioCallEnd(n),c.handleAudioCallEnd({chatid:n,id:h}),l.mid=h,u.clearData(l)}i.closeAllStream(),o.removeAudioCallIcon(n),o.removeScreenShareIcon(n),e.stopNotificationSound(),e.checkAndPlayNotification()},G.prototype.disableAvIcons=function(){},G.prototype.endCall=function(e){try{var t=this.container,i=e.msg,i=i.chatid||i.chid;t.commonImpl.endCallByChid(i),this.checkForCallIcon(e)}catch(e){}},G.prototype.handleUserStatus=function(e){this.checkForCallIcon(e)},G.prototype.joinsupport=function(e){this.checkForCallIcon(e),this.container.commonImpl.checkOnGoingCall()},G.prototype.handleInfoMessage=function(e){this.checkForCallIcon(e),"acctranschat"==e.msg.module&&this.container.detailsHandler.clearBusyUI()},$(document).ready(function(){var e,a={},t=$Support.getParent();(e=a).commonImpl=new d(e),e.audioImpl=new o(e),e.videoImpl=new c(e),e.screen_shareImpl=new r(e),a.ajaxHandler=new N(a),a.detailsHandler=new P(a),a.uiHandler=new H(a),a.logger=LSDebugger.postDebugInfo,a.lsrouter=new G(a),window.SiqAVRouter=new W(a),window.avUIhandler=a.uiHandler,a.commonImpl.checkOnGoingCall(),a.checkDirectCallOnload=function(){var e,t,i,n=localStorage.getItem("siq_directcall");(n=n&&JSON.parse(n))&&(e=n.chid,t=n.media_id,i=n.type,"outgoing"==(n=n.status)?($Support.audioid=t,a.commonImpl.makeCallMissed(i,t),a.detailsHandler.initMissedChat(e,"CALLENDED","2",!0)):"connected"==n&&(a.audioImpl.endOngoingCall(e,t),a.detailsHandler.endSession(e)),localStorage.removeItem("siq_directcall"))},!$Support.isChatExist()&&t.$zohosq.values.initiatecall&&t.$zohosq.call.start()})}();
